!function(t,i){if("object"==typeof exports&&"object"==typeof module)module.exports=i();else if("function"==typeof define&&define.amd)define([],i);else{var e=i();for(var s in e)("object"==typeof exports?exports:t)[s]=e[s]}}(self,(()=>(()=>{"use strict";var t={187:t=>{var i,e="object"==typeof Reflect?Reflect:null,s=e&&"function"==typeof e.apply?e.apply:function(t,i,e){return Function.prototype.apply.call(t,i,e)};i=e&&"function"==typeof e.ownKeys?e.ownKeys:Object.getOwnPropertySymbols?function(t){return Object.getOwnPropertyNames(t).concat(Object.getOwnPropertySymbols(t))}:function(t){return Object.getOwnPropertyNames(t)};var n=Number.isNaN||function(t){return t!=t};function a(){a.init.call(this)}t.exports=a,t.exports.once=function(t,i){return new Promise((function(e,s){function n(e){t.removeListener(i,a),s(e)}function a(){"function"==typeof t.removeListener&&t.removeListener("error",n),e([].slice.call(arguments))}p(t,i,a,{once:!0}),"error"!==i&&function(t,i,e){"function"==typeof t.on&&p(t,"error",i,{once:!0})}(t,n)}))},a.EventEmitter=a,a.prototype._events=void 0,a.prototype._eventsCount=0,a.prototype._maxListeners=void 0;var o=10;function r(t){if("function"!=typeof t)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof t)}function h(t){return void 0===t._maxListeners?a.defaultMaxListeners:t._maxListeners}function g(t,i,e,s){var n,a,o,g;if(r(e),void 0===(a=t._events)?(a=t._events=Object.create(null),t._eventsCount=0):(void 0!==a.newListener&&(t.emit("newListener",i,e.listener?e.listener:e),a=t._events),o=a[i]),void 0===o)o=a[i]=e,++t._eventsCount;else if("function"==typeof o?o=a[i]=s?[e,o]:[o,e]:s?o.unshift(e):o.push(e),(n=h(t))>0&&o.length>n&&!o.warned){o.warned=!0;var c=new Error("Possible EventEmitter memory leak detected. "+o.length+" "+String(i)+" listeners added. Use emitter.setMaxListeners() to increase limit");c.name="MaxListenersExceededWarning",c.emitter=t,c.type=i,c.count=o.length,g=c,console&&console.warn&&console.warn(g)}return t}function c(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,0===arguments.length?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function d(t,i,e){var s={fired:!1,wrapFn:void 0,target:t,type:i,listener:e},n=c.bind(s);return n.listener=e,s.wrapFn=n,n}function u(t,i,e){var s=t._events;if(void 0===s)return[];var n=s[i];return void 0===n?[]:"function"==typeof n?e?[n.listener||n]:[n]:e?function(t){for(var i=new Array(t.length),e=0;e<i.length;++e)i[e]=t[e].listener||t[e];return i}(n):f(n,n.length)}function l(t){var i=this._events;if(void 0!==i){var e=i[t];if("function"==typeof e)return 1;if(void 0!==e)return e.length}return 0}function f(t,i){for(var e=new Array(i),s=0;s<i;++s)e[s]=t[s];return e}function p(t,i,e,s){if("function"==typeof t.on)s.once?t.once(i,e):t.on(i,e);else{if("function"!=typeof t.addEventListener)throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof t);t.addEventListener(i,(function n(a){s.once&&t.removeEventListener(i,n),e(a)}))}}Object.defineProperty(a,"defaultMaxListeners",{enumerable:!0,get:function(){return o},set:function(t){if("number"!=typeof t||t<0||n(t))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+t+".");o=t}}),a.init=function(){void 0!==this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},a.prototype.setMaxListeners=function(t){if("number"!=typeof t||t<0||n(t))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+t+".");return this._maxListeners=t,this},a.prototype.getMaxListeners=function(){return h(this)},a.prototype.emit=function(t){for(var i=[],e=1;e<arguments.length;e++)i.push(arguments[e]);var n="error"===t,a=this._events;if(void 0!==a)n=n&&void 0===a.error;else if(!n)return!1;if(n){var o;if(i.length>0&&(o=i[0]),o instanceof Error)throw o;var r=new Error("Unhandled error."+(o?" ("+o.message+")":""));throw r.context=o,r}var h=a[t];if(void 0===h)return!1;if("function"==typeof h)s(h,this,i);else{var g=h.length,c=f(h,g);for(e=0;e<g;++e)s(c[e],this,i)}return!0},a.prototype.addListener=function(t,i){return g(this,t,i,!1)},a.prototype.on=a.prototype.addListener,a.prototype.prependListener=function(t,i){return g(this,t,i,!0)},a.prototype.once=function(t,i){return r(i),this.on(t,d(this,t,i)),this},a.prototype.prependOnceListener=function(t,i){return r(i),this.prependListener(t,d(this,t,i)),this},a.prototype.removeListener=function(t,i){var e,s,n,a,o;if(r(i),void 0===(s=this._events))return this;if(void 0===(e=s[t]))return this;if(e===i||e.listener===i)0==--this._eventsCount?this._events=Object.create(null):(delete s[t],s.removeListener&&this.emit("removeListener",t,e.listener||i));else if("function"!=typeof e){for(n=-1,a=e.length-1;a>=0;a--)if(e[a]===i||e[a].listener===i){o=e[a].listener,n=a;break}if(n<0)return this;0===n?e.shift():function(t,i){for(;i+1<t.length;i++)t[i]=t[i+1];t.pop()}(e,n),1===e.length&&(s[t]=e[0]),void 0!==s.removeListener&&this.emit("removeListener",t,o||i)}return this},a.prototype.off=a.prototype.removeListener,a.prototype.removeAllListeners=function(t){var i,e,s;if(void 0===(e=this._events))return this;if(void 0===e.removeListener)return 0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==e[t]&&(0==--this._eventsCount?this._events=Object.create(null):delete e[t]),this;if(0===arguments.length){var n,a=Object.keys(e);for(s=0;s<a.length;++s)"removeListener"!==(n=a[s])&&this.removeAllListeners(n);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(i=e[t]))this.removeListener(t,i);else if(void 0!==i)for(s=i.length-1;s>=0;s--)this.removeListener(t,i[s]);return this},a.prototype.listeners=function(t){return u(this,t,!0)},a.prototype.rawListeners=function(t){return u(this,t,!1)},a.listenerCount=function(t,i){return"function"==typeof t.listenerCount?t.listenerCount(i):l.call(t,i)},a.prototype.listenerCount=l,a.prototype.eventNames=function(){return this._eventsCount>0?i(this._events):[]}}},i={};function e(s){var n=i[s];if(void 0!==n)return n.exports;var a=i[s]={exports:{}};return t[s](a,a.exports,e),a.exports}e.d=(t,i)=>{for(var s in i)e.o(i,s)&&!e.o(t,s)&&Object.defineProperty(t,s,{enumerable:!0,get:i[s]})},e.o=(t,i)=>Object.prototype.hasOwnProperty.call(t,i),e.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})};var s={};return(()=>{e.r(s),e.d(s,{APP_VERSION_CODE:()=>Bi,APP_VERSION_NAME:()=>Pi,CARRIER_NAME:()=>Li,CacheStrategy:()=>_t,DEVICE_LOCALE:()=>Ri,DEVICE_MODEL:()=>Ai,DEVICE_TYPE:()=>Ni,DecisionApiConfig:()=>$t,DecisionMode:()=>vt,EventCategory:()=>Et,FLAGSHIP_CLIENT:()=>Qi,FLAGSHIP_CONTEXT:()=>$i,FLAGSHIP_VERSION:()=>qi,FLAGSHIP_VISITOR:()=>Ki,FSFetchReasons:()=>mt,FSFetchStatus:()=>zi,FSFlag:()=>ae,FSFlagCollection:()=>oe,FSFlagMetadata:()=>ji,FSFlagStatus:()=>se,FSSdkStatus:()=>pt,Flagship:()=>me,HitType:()=>kt,INTERFACE_NAME:()=>Gi,INTERNET_CONNECTION:()=>Ui,IP:()=>Hi,LOCATION_CITY:()=>Di,LOCATION_COUNTRY:()=>Mi,LOCATION_LAT:()=>Oi,LOCATION_LONG:()=>Fi,LOCATION_REGION:()=>bi,LogLevel:()=>It,OS_NAME:()=>wi,OS_VERSION_CODE:()=>xi,OS_VERSION_NAME:()=>Vi,TroubleshootingLabel:()=>Ct,Visitor:()=>ft,VisitorCacheStatus:()=>yt,default:()=>_e});var t=e(187);const i="4.0.4",n={name:"TypeScript",version:i},a=25e5,o="https://decision.flagship.io/v2/",r="https://events.flagship.io",h="https://events.flagship.io/troubleshooting",g="https://events.flagship.io/analytics",c="activate",d="https://qa-assistant.flagship.io/bundle.js",u="https://staging-qa-assistant.flagship.io/bundle.js",l="https://local-qa-assistant.flagship.io/bundle.js",f="qa-assistant.abtasty.com",p="qa-assistant.flagship.io",v="fs_consent",I="FS_IS_QA_MODE_ENABLED",m="FS_FORCED_VARIATIONS",_="FS_QA_ASSISTANT_SCRIPT_TAG_ID",C=144e5,y="ready",T="https://docs.developers.flagship.io/docs/js-v3",k=`Params 'envId' and 'apiKey' must not be null or empty.\n  Learn more: ${T}#initialization`,E="{0} must be a {1}",S="Visitor {0}, method {1} is deactivated while SDK status is: {2}.",R="SEND BATCH",N="without calling `fetchFlags` method afterwards. So, the value of the flag `{1}` might be outdated",A=`You can't create a new visitor without first calling the "Flagship.start" method.\nLearn more: ${T}#initialization\n`,D="INITIALIZATION",b="UPDATE CONTEXT",M="NEW VISITOR",O="ADD HIT",F="cid",H="cuid",w="vid",V="ds",x="qt",L="APP",U="x-api-key",P="Content-Type",B="x-sdk-client",G="x-sdk-version",Q="application/json",q="BUCKETING",K=`Visitor {0}, the key '{1}' must be a non null String.\nLearn more: ${T}#updating-the-visitor-context`,$=`Visitor {0}, 'value' for key '{1}[], must be one of the following types : String, Number, Boolean\nLearn more: ${T}#updating-the-visitor-context`,j=`visitor {0}, Predefined Context {0} must be of type {1}\nLearn more: ${T}#predefined-user-context-keys-`,z="FETCH_FLAGS",J="FLAG_VALUE",W="GET_FLAG",Y="FLAG_VISITOR_EXPOSED",Z="FLAG_METADATA",X="Visitor {0}, No Flags found for key {1}:  Empty metadata object is returned",tt=`Visitor {0}, Flag for key {1} Method Flag.metadata is deactivated while SDK status is NOT_READY: Empty metadata object is returned {2}\nLearn more: ${T}#getting-flags-campaigns-metadata`,it="AUTHENTICATE",et=`Visitor {0}, visitorId must not be null or empty\nLearn more: ${T}#authenticate`,st="UNAUTHENTICATE",nt="ALLOCATION",at=`lookupVisitor method has loaded a bad format version ({0}) for visitor {1}.\nLearn more: ${T}#managing-visitor-cache`,ot="CACHE",rt="visitor {0}. {1} threw an exception {2}",ht="{0} threw an exception {1}",gt="TRACKING_MANAGER",ct="{0} Unexpected Error occurred {1}",dt="{0} has been sent : {1}",ut="ACTIVATE HIT",lt="BATCH HIT";class ft extends t.EventEmitter{visitorDelegate;constructor(t){super(),this.visitorDelegate=t,this.visitorDelegate.on(y,(t=>{this.emit(y,t)}))}get visitorId(){return this.visitorDelegate.visitorId}set visitorId(t){this.visitorDelegate.visitorId=t}get anonymousId(){return this.visitorDelegate.anonymousId}get config(){return this.visitorDelegate.config}get context(){return this.visitorDelegate.context}get fetchStatus(){return this.visitorDelegate.fetchStatus}get hasConsented(){return this.visitorDelegate.hasConsented}setConsent(t){this.visitorDelegate.setConsent(t)}updateContext(t,i){this.visitorDelegate.updateContext(t,i)}clearContext(){this.visitorDelegate.clearContext()}getFlag(t){return this.visitorDelegate.getFlag(t)}getFlags(){return this.visitorDelegate.getFlags()}fetchFlags(){return this.visitorDelegate.fetchFlags()}sendHit(t){return this.visitorDelegate.sendHit(t)}sendHits(t){return this.visitorDelegate.sendHits(t)}authenticate(t){this.visitorDelegate.authenticate(t)}unauthenticate(){this.visitorDelegate.unauthenticate()}}var pt,vt,It,mt,_t,Ct,yt,Tt,kt,Et,St,Rt,Nt;function At(t,...i){let e=t;for(let t=0;t<i.length;t++){const s=i[t],n="string"==typeof s?s:JSON.stringify(s instanceof Map?Array.from(s.values()):s);e=e.replace(new RegExp(`\\{${t}\\}`,"g"),n)}return e}function Dt(t,i,e,...s){!t||!t.logLevel||t.logLevel<It.ERROR||bt(t,At(e,...s),i)}function bt(t,i,e){!t||!t.logLevel||t.logLevel<It.ERROR||("function"==typeof t.onLog&&t.onLog(It.ERROR,e,i),t.logManager&&"function"==typeof t.logManager.error&&t.logManager.error(i,e))}function Mt(t,i,e,...s){!t||!t.logLevel||t.logLevel<It.WARNING||Ot(t,At(e,...s),i)}function Ot(t,i,e){!t||!t.logLevel||t.logLevel<It.WARNING||("function"==typeof t.onLog&&t.onLog(It.WARNING,e,i),t.logManager&&"function"==typeof t.logManager.warning&&t.logManager.warning(i,e))}function Ft(t,i,e,...s){!t||!t.logLevel||t.logLevel<It.INFO||Ht(t,At(e,...s),i)}function Ht(t,i,e){!t||!t.logLevel||t.logLevel<It.INFO||("function"==typeof t.onLog&&t.onLog(It.INFO,e,i),t.logManager&&"function"==typeof t.logManager.info&&t.logManager.info(i,e))}function wt(t,i,e,...s){!t||!t.logLevel||t.logLevel<It.DEBUG||Vt(t,At(e,...s),i)}function Vt(t,i,e){!t||!t.logLevel||t.logLevel<It.DEBUG||("function"==typeof t.onLog&&t.onLog(It.DEBUG,e,i),t.logManager&&"function"==typeof t.logManager.debug&&t.logManager.debug(i,e))}function xt(){return"undefined"!=typeof window&&void 0!==window.document}function Lt(t,i){return typeof t==typeof i&&("object"!=typeof t||"object"!=typeof i||Array.isArray(t)===Array.isArray(i))}function Ut(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(t){const i=16*Math.random()|0;return("x"===t?i:3&i|8).toString(16)}))}function Pt(t,i){return JSON.stringify({message:t,data:i})}function Bt(t){const i=JSON.stringify(t);return Array.from(i,(t=>t.charCodeAt(0).toString(16))).join("")}function Gt(t,i){if("string"!=typeof t)return Dt(i,"hexToValue","Invalid hex string: {0}",t),null;let e="";for(let s=0;s<t.length;s+=2){const n=t.slice(s,s+2),a=parseInt(n,16);if(isNaN(a))return Dt(i,"hexToValue","Invalid hex character: {0}",n),null;e+=String.fromCharCode(a)}try{return JSON.parse(e)}catch(t){return Dt(i,"hexToValue","Error while parsing JSON: {0}",t),null}}!function(t){t[t.SDK_NOT_INITIALIZED=0]="SDK_NOT_INITIALIZED",t[t.SDK_INITIALIZING=1]="SDK_INITIALIZING",t[t.SDK_PANIC=2]="SDK_PANIC",t[t.SDK_INITIALIZED=3]="SDK_INITIALIZED"}(pt||(pt={})),function(t){t.DECISION_API="DECISION-API",t.BUCKETING="BUCKETING",t.BUCKETING_EDGE="BUCKETING_EDGE"}(vt||(vt={})),function(t){t[t.NONE=0]="NONE",t[t.EMERGENCY=1]="EMERGENCY",t[t.ALERT=2]="ALERT",t[t.CRITICAL=3]="CRITICAL",t[t.ERROR=4]="ERROR",t[t.WARNING=5]="WARNING",t[t.NOTICE=6]="NOTICE",t[t.INFO=7]="INFO",t[t.DEBUG=8]="DEBUG",t[t.ALL=9]="ALL"}(It||(It={})),function(t){t.UPDATE_CONTEXT="UPDATE_CONTEXT",t.AUTHENTICATE="AUTHENTICATE",t.UNAUTHENTICATE="UNAUTHENTICATE",t.FETCH_ERROR="FETCH_ERROR",t.READ_FROM_CACHE="READ_FROM_CACHE",t.VISITOR_CREATED="VISITOR_CREATED",t.NONE="NONE"}(mt||(mt={})),function(t){t[t.CONTINUOUS_CACHING=0]="CONTINUOUS_CACHING",t[t.PERIODIC_CACHING=1]="PERIODIC_CACHING"}(_t||(_t={}));class Qt{_batchIntervals;_poolMaxSize;_batchStrategy;constructor(t){this.batchIntervals=t?.batchIntervals,this.poolMaxSize=t?.poolMaxSize,this._batchStrategy=this.getCacheStrategy(t?.cacheStrategy)}getCacheStrategy(t){return"number"==typeof t?t:xt()?_t.CONTINUOUS_CACHING:_t.PERIODIC_CACHING}get batchIntervals(){return this._batchIntervals}set batchIntervals(t){("number"!=typeof t||t<1||t>10800)&&(t=xt()?5:10),this._batchIntervals=t}get poolMaxSize(){return this._poolMaxSize}set poolMaxSize(t){("number"!=typeof t||t<5)&&(t=xt()?10:100),this._poolMaxSize=t}get cacheStrategy(){return this._batchStrategy}}class qt{_envId;_apiKey;_decisionMode;_timeout;_logLevel;_onSdkStatusChanged;_logManager;_fetchNow;_pollingInterval;_onBucketingFail;_onBucketingSuccess;_onBucketingUpdated;_reuseVisitorIds;_initialBucketing;_decisionApiUrl;_hitDeduplicationTime;_visitorCacheImplementation;_hitCacheImplementation;_disableCache;_trackingManagerConfig;_onVisitorExposed;_fetchThirdPartyData;_nextFetchConfig;_fetchFlagsBufferingTime;_disableDeveloperUsageTracking;_onLog;_isQAModeEnabled;get isQAModeEnabled(){return this._isQAModeEnabled}set isQAModeEnabled(t){this._isQAModeEnabled=t}_enableAnalytics;get disableDeveloperUsageTracking(){return this._disableDeveloperUsageTracking}set disableDeveloperUsageTracking(t){this._disableDeveloperUsageTracking=t}get fetchFlagsBufferingTime(){return this._fetchFlagsBufferingTime}set fetchFlagsBufferingTime(t){this._fetchFlagsBufferingTime=t}get nextFetchConfig(){return this._nextFetchConfig}set nextFetchConfig(t){this._nextFetchConfig=t}get fetchThirdPartyData(){return this._fetchThirdPartyData}set fetchThirdPartyData(t){this._fetchThirdPartyData=t}get trackingManagerConfig(){return this._trackingManagerConfig}get onLog(){return this._onLog}set onLog(t){this._onLog=t}get onVisitorExposed(){return this._onVisitorExposed}constructor(t){const{envId:i,apiKey:e,timeout:s,logLevel:n,logManager:a,onSdkStatusChanged:r,fetchNow:h,decisionMode:g,reuseVisitorIds:c,initialBucketing:d,decisionApiUrl:u,hitDeduplicationTime:l,visitorCacheImplementation:f,hitCacheImplementation:p,disableCache:v,language:I,sdkVersion:m,trackingManagerConfig:_,onLog:C,onVisitorExposed:y,nextFetchConfig:T,fetchFlagsBufferingTime:k,disableDeveloperUsageTracking:E}=t;this.initQaMode(),this.initSDKInfo(I,m),a&&(this.logManager=a),this.fetchFlagsBufferingTime=k??2,this.nextFetchConfig=T||{revalidate:20},this._trackingManagerConfig=new Qt(_||{}),this.onLog=C,this.decisionApiUrl=u||o,this._envId=i,this._apiKey=e,this.logLevel=n??It.ALL,this.timeout=s||2,this.fetchNow=void 0===h||h,this.reuseVisitorIds=void 0===c||c,this._decisionMode=g||vt.DECISION_API,this._initialBucketing=d,this.hitDeduplicationTime=l??2.5,this.disableCache=!!v,this.disableDeveloperUsageTracking=E||!1,f&&(this.visitorCacheImplementation=f),p&&(this.hitCacheImplementation=p),this.onSdkStatusChanged=r,this._onVisitorExposed=y}initQaMode(){if(xt())try{const t=sessionStorage.getItem(I);this.isQAModeEnabled=t?JSON.parse(t):void 0}catch(t){bt(this,Pt(t.message||t),"initQaMode"),this.isQAModeEnabled=!1}}initSDKInfo(t,e){switch(t){case 1:n.name="ReactJS",n.version=e??i;break;case 2:n.name="React-Native",n.version=e??i;break;default:n.name="undefined"!=typeof window&&"Deno"in window?"Deno":"TypeScript",n.version=i}}get initialBucketing(){return this._initialBucketing}set initialBucketing(t){this._initialBucketing=t}get reuseVisitorIds(){return this._reuseVisitorIds}set reuseVisitorIds(t){this._reuseVisitorIds=t}get onBucketingSuccess(){return this._onBucketingSuccess}set onBucketingSuccess(t){this._onBucketingSuccess=t}get onBucketingFail(){return this._onBucketingFail}set onBucketingFail(t){this._onBucketingFail=t}get onBucketingUpdated(){return this._onBucketingUpdated}set onBucketingUpdated(t){this._onBucketingUpdated=t}set envId(t){this._envId=t}get envId(){return this._envId}set apiKey(t){this._apiKey=t}get apiKey(){return this._apiKey}get decisionMode(){return this._decisionMode}get timeout(){return this._timeout}set timeout(t){this._timeout=t}get logLevel(){return this._logLevel}set logLevel(t){this._logLevel=t}get fetchNow(){return this._fetchNow}set fetchNow(t){this._fetchNow=t}get pollingInterval(){return this._pollingInterval}set pollingInterval(t){this._pollingInterval=t}get hitDeduplicationTime(){return this._hitDeduplicationTime}set hitDeduplicationTime(t){"number"==typeof t?this._hitDeduplicationTime=t:bt(this,At(E,"hitDeduplicationTime","number"),"hitDeduplicationTime")}get visitorCacheImplementation(){return this._visitorCacheImplementation}set visitorCacheImplementation(t){this._visitorCacheImplementation=t}get hitCacheImplementation(){return this._hitCacheImplementation}set hitCacheImplementation(t){this._hitCacheImplementation=t}get disableCache(){return this._disableCache}set disableCache(t){this._disableCache=t}get onSdkStatusChanged(){return this._onSdkStatusChanged}set onSdkStatusChanged(t){t&&"function"!=typeof t?bt(this,"statusChangedCallback must be a function","onSdkStatusChanged"):this._onSdkStatusChanged=t}get logManager(){return this._logManager}set logManager(t){this._logManager=t}get decisionApiUrl(){return this._decisionApiUrl}set decisionApiUrl(t){"string"==typeof t?this._decisionApiUrl=t:bt(this,At(E,"decisionApiUrl","string"),"decisionApiUrl")}}class Kt extends qt{constructor(t){super({...t,decisionMode:vt.BUCKETING}),this.pollingInterval=t?.pollingInterval??5,this.onBucketingFail=t?.onBucketingFail,this.onBucketingSuccess=t?.onBucketingSuccess,this.onBucketingUpdated=t?.onBucketingUpdated,this.fetchThirdPartyData=t?.fetchThirdPartyData}}class $t extends qt{constructor(t){super({...t,decisionMode:vt.DECISION_API})}}class jt{_config;_decisionManager;_trackingManager;constructor(t,i,e){this._config=t,this._decisionManager=i,this._trackingManager=e}get config(){return this._config}set config(t){this._config=t}get decisionManager(){return this._decisionManager}set decisionManager(t){this._decisionManager=t}get trackingManager(){return this._trackingManager}set trackingManager(t){this._trackingManager=t}}!function(t){t.VISITOR_SEND_HIT="VISITOR_SEND_HIT",t.VISITOR_FETCH_CAMPAIGNS_ERROR="VISITOR_FETCH_CAMPAIGNS_ERROR",t.VISITOR_FETCH_CAMPAIGNS="VISITOR_FETCH_CAMPAIGNS",t.VISITOR_AUTHENTICATE="VISITOR_AUTHENTICATE",t.VISITOR_UNAUTHENTICATE="VISITOR_UNAUTHENTICATE",t.VISITOR_EXPOSED_FLAG_NOT_FOUND="VISITOR_EXPOSED_FLAG_NOT_FOUND",t.FLAG_VALUE_NOT_CALLED="FLAG_VALUE_NOT_CALLED",t.GET_FLAG_VALUE_FLAG_NOT_FOUND="GET_FLAG_VALUE_FLAG_NOT_FOUND",t.GET_FLAG_METADATA_TYPE_WARNING="GET_FLAG_METADATA_TYPE_WARNING",t.GET_FLAG_VALUE_TYPE_WARNING="GET_FLAG_VALUE_TYPE_WARNING",t.VISITOR_EXPOSED_TYPE_WARNING="VISITOR_EXPOSED_TYPE_WARNING",t.VISITOR_SEND_ACTIVATE="VISITOR_SEND_ACTIVATE",t.GET_CAMPAIGNS_ROUTE_RESPONSE_ERROR="GET_CAMPAIGNS_ROUTE_RESPONSE_ERROR",t.GET_CAMPAIGNS_ROUTE_RESPONSE="GET_CAMPAIGNS_ROUTE_RESPONSE",t.SDK_BUCKETING_FILE="SDK_BUCKETING_FILE",t.SEND_ACTIVATE_HIT_ROUTE_ERROR="SEND_ACTIVATE_HIT_ROUTE_ERROR",t.SEND_BATCH_HIT_ROUTE_RESPONSE_ERROR="SEND_BATCH_HIT_ROUTE_RESPONSE_ERROR",t.SEND_HIT_ROUTE_ERROR="SEND_HIT_ROUTE_ERROR",t.SDK_BUCKETING_FILE_ERROR="SDK_BUCKETING_FILE_ERROR",t.SDK_CONFIG="SDK_CONFIG"}(Ct||(Ct={})),function(t){t.NONE="NONE",t.ANONYMOUS_ID_CACHE="ANONYMOUS_ID_CACHE",t.VISITOR_ID_CACHE="VISITOR_ID_CACHE",t.VISITOR_ID_CACHE_NOT_ANONYMOUS_ID_CACHE="VISITOR_ID_CACHE_NOT_ANONYMOUS_ID_CACHE"}(yt||(yt={}));class zt{_visitorId;_config;_type;_ds;_anonymousId;_userIp;_screenResolution;_locale;_sessionNumber;_key;_createdAt;_qaMode;get key(){return this._key}set key(t){this._key=t}get sessionNumber(){return this._sessionNumber}set sessionNumber(t){this._sessionNumber=t}get locale(){return this._locale}set locale(t){this._locale=t}get screenResolution(){return this._screenResolution}set screenResolution(t){this._screenResolution=t}get userIp(){return this._userIp}set userIp(t){this._userIp=t}get anonymousId(){return this._anonymousId}set anonymousId(t){this._anonymousId=t}get visitorId(){return this._visitorId}set visitorId(t){this._visitorId=t}get ds(){return this._ds}set ds(t){this._ds=t}get type(){return this._type}get config(){return this._config}set config(t){this._config=t}get createdAt(){return this._createdAt}set createdAt(t){this._createdAt=t}get qaMode(){return this._qaMode}set qaMode(t){this._qaMode=t}constructor(t){const{type:i,userIp:e,screenResolution:s,locale:n,sessionNumber:a,visitorId:o,anonymousId:r,ds:h,qaMode:g}=t;this._type=i,e&&(this.userIp=e),s&&(this.screenResolution=s),n&&(this.locale=n),a&&(this.sessionNumber=a),this.visitorId=o,this._anonymousId=r||null,this.createdAt=Date.now(),this.ds=h||L,this.qaMode=g}isNotEmptyString(t,i){return!(!t||"string"!=typeof t)||(bt(this.config,At(E,i,"string"),i),!1)}isNumeric(t,i){return!(!t||"number"!=typeof t)||(bt(this.config,At(E,i,"number"),i),!1)}isInteger(t,i){return!!Number.isInteger(t)||(bt(this.config,At(E,i,"integer"),i),!1)}toApiKeys(){const t={[w]:this.visitorId,[V]:this.ds,[F]:`${this.config?.envId}`,t:this.type,[H]:null,[x]:Date.now()-this._createdAt};return this.qaMode&&(t.qa=!0),this.userIp&&(t.uip=this.userIp),this.screenResolution&&(t.sr=this.screenResolution),this.locale&&(t.ul=this.locale),this.sessionNumber&&(t.sn=this.sessionNumber),this.visitorId&&this.anonymousId&&(t[w]=this.anonymousId,t[H]=this.visitorId),t}toObject(){return{key:this.key,visitorId:this.visitorId,ds:this.ds,type:this.type,userIp:this.userIp,screenResolution:this.screenResolution,locale:this.locale,sessionNumber:this.sessionNumber,anonymousId:this.anonymousId,createdAt:this.createdAt,qaMode:this.qaMode}}isReady(t=!0){return!!(this.visitorId&&this.ds&&this.config&&this.config.envId&&this.type)}}!function(t){t[t.Timer=0]="Timer",t[t.BatchLength=1]="BatchLength",t[t.Flush=2]="Flush",t[t.ActivateLength=3]="ActivateLength",t[t.DirectHit=4]="DirectHit",t[t.DirectActivate=5]="DirectActivate"}(Tt||(Tt={}));class Jt extends zt{_logVersion;_logLevel;_accountId;_envId;_timestamp;_label;_stackType;_stackName;_stackVersion;_stackOriginName;_stackOriginVersion;_sdkStatus;_sdkConfigMode;_sdkConfigCustomLogManager;_sdkConfigCustomCacheManager;_sdkConfigStatusListener;_sdkConfigTimeout;_sdkConfigPollingTime;_sdkConfigTrackingManagerConfigStrategy;_sdkConfigTrackingManagerConfigBatchIntervals;_sdkConfigTrackingManagerConfigBatchLength;_httpRequestUrl;_httpRequestMethod;_httpRequestHeaders;_httpRequestBody;_httpResponseUrl;_httpResponseMethod;_httpResponseHeaders;_httpResponseBody;_visitorStatus;_visitorInstanceType;_visitorContext;_visitorConsent;_visitorAssignmentHistory;_visitorFlags;_visitorIsAuthenticated;_flagKey;_flagValue;_flagDefault;_flagMetadataCampaignId;_flagMetadataVariationGroupId;_flagMetadataVariationId;_flagMetadataCampaignSlug;_flagMetadataCampaignType;_sdkConfigFetchNow;_sdkConfigReuseVisitorIds;_sdkConfigInitialBucketing;_sdkConfigDecisionApiUrl;_sdkConfigHitDeduplicationTime;_visitorInitialCampaigns;_visitorInitialFlagsData;_visitorCampaign;_httRequestTime;_hitContent;_httpInstanceId;_lastInitializationTimestamp;_lastBucketingTimestamp;_batchTriggeredBy;_visitorCampaignFromCache;_timeZone;_flagMetadataCampaignIsReference;_contextKey;_contextValue;_sdkBucketingFile;_flagMetadataCampaignName;_flagMetadataVariationGroupName;_flagMetadataVariationName;_sdkConfigUsingCustomHitCache;_sdkConfigUsingCustomVisitorCache;_sdkConfigUsingOnVisitorExposed;_sdkConfigFetchThirdPartyData;_sdkConfigFetchFlagsBufferingTime;_sdkConfigNextFetchConfig;_sdkConfigDisableDeveloperUsageTracking;_sdkConfigDisableCache;_sdkConfigLogLevel;get sdkConfigLogLevel(){return this._sdkConfigLogLevel}set sdkConfigLogLevel(t){this._sdkConfigLogLevel=t}_visitorSessionId;_traffic;_flagshipInstanceId;get traffic(){return this._traffic}set traffic(t){this._traffic=t}get flagshipInstanceId(){return this._flagshipInstanceId}set flagshipInstanceId(t){this._flagshipInstanceId=t}get visitorSessionId(){return this._visitorSessionId}set visitorSessionId(t){this._visitorSessionId=t}get sdkConfigDisableCache(){return this._sdkConfigDisableCache}set sdkConfigDisableCache(t){this._sdkConfigDisableCache=t}get sdkConfigDisableDeveloperUsageTracking(){return this._sdkConfigDisableDeveloperUsageTracking}set sdkConfigDisableDeveloperUsageTracking(t){this._sdkConfigDisableDeveloperUsageTracking=t}get sdkConfigNextFetchConfig(){return this._sdkConfigNextFetchConfig}set sdkConfigNextFetchConfig(t){this._sdkConfigNextFetchConfig=t}get sdkConfigFetchFlagsBufferingTime(){return this._sdkConfigFetchFlagsBufferingTime}set sdkConfigFetchFlagsBufferingTime(t){this._sdkConfigFetchFlagsBufferingTime=t}get sdkConfigFetchThirdPartyData(){return this._sdkConfigFetchThirdPartyData}set sdkConfigFetchThirdPartyData(t){this._sdkConfigFetchThirdPartyData=t}get sdkConfigUsingOnVisitorExposed(){return this._sdkConfigUsingOnVisitorExposed}set sdkConfigUsingOnVisitorExposed(t){this._sdkConfigUsingOnVisitorExposed=t}get sdkConfigUsingCustomVisitorCache(){return this._sdkConfigUsingCustomVisitorCache}set sdkConfigUsingCustomVisitorCache(t){this._sdkConfigUsingCustomVisitorCache=t}get sdkConfigUsingCustomHitCache(){return this._sdkConfigUsingCustomHitCache}set sdkConfigUsingCustomHitCache(t){this._sdkConfigUsingCustomHitCache=t}get flagMetadataVariationName(){return this._flagMetadataVariationName}set flagMetadataVariationName(t){this._flagMetadataVariationName=t}get flagMetadataVariationGroupName(){return this._flagMetadataVariationGroupName}set flagMetadataVariationGroupName(t){this._flagMetadataVariationGroupName=t}get flagMetadataCampaignName(){return this._flagMetadataCampaignName}set flagMetadataCampaignName(t){this._flagMetadataCampaignName=t}get sdkBucketingFile(){return this._sdkBucketingFile}set sdkBucketingFile(t){this._sdkBucketingFile=t}get contextValue(){return this._contextValue}set contextValue(t){this._contextValue=t}get contextKey(){return this._contextKey}set contextKey(t){this._contextKey=t}get flagMetadataCampaignIsReference(){return this._flagMetadataCampaignIsReference}set flagMetadataCampaignIsReference(t){this._flagMetadataCampaignIsReference=t}get timeZone(){return this._timeZone}set timeZone(t){this._timeZone=t}get visitorCampaignFromCache(){return this._visitorCampaignFromCache}set visitorCampaignFromCache(t){this._visitorCampaignFromCache=t}get batchTriggeredBy(){return this._batchTriggeredBy}set batchTriggeredBy(t){this._batchTriggeredBy=t}get lastBucketingTimestamp(){return this._lastBucketingTimestamp}set lastBucketingTimestamp(t){this._lastBucketingTimestamp=t}get lastInitializationTimestamp(){return this._lastInitializationTimestamp}set lastInitializationTimestamp(t){this._lastInitializationTimestamp=t}get hitContent(){return this._hitContent}set hitContent(t){this._hitContent=t}get httpResponseTime(){return this._httRequestTime}set httpResponseTime(t){this._httRequestTime=t}get visitorCampaigns(){return this._visitorCampaign}set visitorCampaigns(t){this._visitorCampaign=t}get visitorInitialFlagsData(){return this._visitorInitialFlagsData}set visitorInitialFlagsData(t){this._visitorInitialFlagsData=t}get visitorInitialCampaigns(){return this._visitorInitialCampaigns}set visitorInitialCampaigns(t){this._visitorInitialCampaigns=t}get sdkConfigHitDeduplicationTime(){return this._sdkConfigHitDeduplicationTime}set sdkConfigHitDeduplicationTime(t){this._sdkConfigHitDeduplicationTime=t}get sdkConfigDecisionApiUrl(){return this._sdkConfigDecisionApiUrl}set sdkConfigDecisionApiUrl(t){this._sdkConfigDecisionApiUrl=t}get sdkConfigInitialBucketing(){return this._sdkConfigInitialBucketing}set sdkConfigInitialBucketing(t){this._sdkConfigInitialBucketing=t}get sdkConfigReuseVisitorIds(){return this._sdkConfigReuseVisitorIds}set sdkConfigReuseVisitorIds(t){this._sdkConfigReuseVisitorIds=t}get sdkConfigFetchNow(){return this._sdkConfigFetchNow}set sdkConfigFetchNow(t){this._sdkConfigFetchNow=t}get flagMetadataCampaignType(){return this._flagMetadataCampaignType}set flagMetadataCampaignType(t){this._flagMetadataCampaignType=t}get flagMetadataCampaignSlug(){return this._flagMetadataCampaignSlug}set flagMetadataCampaignSlug(t){this._flagMetadataCampaignSlug=t}get flagMetadataVariationId(){return this._flagMetadataVariationId}set flagMetadataVariationId(t){this._flagMetadataVariationId=t}get flagMetadataVariationGroupId(){return this._flagMetadataVariationGroupId}set flagMetadataVariationGroupId(t){this._flagMetadataVariationGroupId=t}get flagMetadataCampaignId(){return this._flagMetadataCampaignId}set flagMetadataCampaignId(t){this._flagMetadataCampaignId=t}get flagDefault(){return this._flagDefault}set flagDefault(t){this._flagDefault=t}get flagValue(){return this._flagValue}set flagValue(t){this._flagValue=t}get flagKey(){return this._flagKey}set flagKey(t){this._flagKey=t}get visitorIsAuthenticated(){return this._visitorIsAuthenticated}set visitorIsAuthenticated(t){this._visitorIsAuthenticated=t}get visitorFlags(){return this._visitorFlags}set visitorFlags(t){this._visitorFlags=t}get visitorAssignmentHistory(){return this._visitorAssignmentHistory}set visitorAssignmentHistory(t){this._visitorAssignmentHistory=t}get visitorConsent(){return this._visitorConsent}set visitorConsent(t){this._visitorConsent=t}get visitorContext(){return this._visitorContext}set visitorContext(t){this._visitorContext=t}get visitorInstanceType(){return this._visitorInstanceType}set visitorInstanceType(t){this._visitorInstanceType=t}get visitorStatus(){return this._visitorStatus}set visitorStatus(t){this._visitorStatus=t}get httpResponseBody(){return this._httpResponseBody}set httpResponseBody(t){this._httpResponseBody=t}_httpResponseCode;get httpResponseCode(){return this._httpResponseCode}set httpResponseCode(t){this._httpResponseCode=t}get httpResponseHeaders(){return this._httpResponseHeaders}set httpResponseHeaders(t){this._httpResponseHeaders=t}get httpResponseMethod(){return this._httpResponseMethod}set httpResponseMethod(t){this._httpResponseMethod=t}get httpResponseUrl(){return this._httpResponseUrl}set httpResponseUrl(t){this._httpResponseUrl=t}get httpRequestBody(){return this._httpRequestBody}set httpRequestBody(t){this._httpRequestBody=t}get httpRequestHeaders(){return this._httpRequestHeaders}set httpRequestHeaders(t){this._httpRequestHeaders=t}get httpRequestMethod(){return this._httpRequestMethod}set httpRequestMethod(t){this._httpRequestMethod=t}get httpRequestUrl(){return this._httpRequestUrl}set httpRequestUrl(t){this._httpRequestUrl=t}get sdkConfigTrackingManagerPoolMaxSize(){return this._sdkConfigTrackingManagerConfigBatchLength}set sdkConfigTrackingManagerPoolMaxSize(t){this._sdkConfigTrackingManagerConfigBatchLength=t}get sdkConfigTrackingManagerBatchIntervals(){return this._sdkConfigTrackingManagerConfigBatchIntervals}set sdkConfigTrackingManagerBatchIntervals(t){this._sdkConfigTrackingManagerConfigBatchIntervals=t}get sdkConfigTrackingManagerStrategy(){return this._sdkConfigTrackingManagerConfigStrategy}set sdkConfigTrackingManagerStrategy(t){this._sdkConfigTrackingManagerConfigStrategy=t}get sdkConfigPollingInterval(){return this._sdkConfigPollingTime}set sdkConfigPollingInterval(t){this._sdkConfigPollingTime=t}get sdkConfigTimeout(){return this._sdkConfigTimeout}set sdkConfigTimeout(t){this._sdkConfigTimeout=t}get sdkConfigStatusListener(){return this._sdkConfigStatusListener}set sdkConfigStatusListener(t){this._sdkConfigStatusListener=t}get sdkConfigCustomCacheManager(){return this._sdkConfigCustomCacheManager}set sdkConfigCustomCacheManager(t){this._sdkConfigCustomCacheManager=t}get sdkConfigCustomLogManager(){return this._sdkConfigCustomLogManager}set sdkConfigCustomLogManager(t){this._sdkConfigCustomLogManager=t}get sdkConfigMode(){return this._sdkConfigMode}set sdkConfigMode(t){this._sdkConfigMode=t}get sdkStatus(){return this._sdkStatus}set sdkStatus(t){this._sdkStatus=t}get stackOriginVersion(){return this._stackOriginVersion}set stackOriginVersion(t){this._stackOriginVersion=t}get stackOriginName(){return this._stackOriginName}set stackOriginName(t){this._stackOriginName=t}get stackVersion(){return this._stackVersion}set stackVersion(t){this._stackVersion=t}get stackName(){return this._stackName}set stackName(t){this._stackName=t}get stackType(){return this._stackType}set stackType(t){this._stackType=t}get label(){return this._label}set label(t){this._label=t}get timestamp(){return this._timestamp}set timestamp(t){this._timestamp=t}get envId(){return this._envId}set envId(t){this._envId=t}get accountId(){return this._accountId}set accountId(t){this._accountId=t}get logLevel(){return this._logLevel}set logLevel(t){this._logLevel=t}get version(){return this._logVersion}set version(t){this._logVersion=t}constructor(t){super({type:t.type,userIp:t.userIp,screenResolution:t.screenResolution,locale:t.locale,sessionNumber:t.sessionNumber,visitorId:t.visitorId,anonymousId:t.anonymousId});const{version:i,logLevel:e,accountId:s,envId:a,timestamp:o,label:r,stackType:h,stackName:g,stackVersion:c,stackOriginName:d,stackOriginVersion:u,sdkStatus:l,sdkConfigMode:f,sdkConfigCustomLogManager:p,sdkConfigCustomCacheManager:v,sdkConfigStatusListener:I,sdkConfigTimeout:m,sdkConfigPollingInterval:_,sdkConfigTrackingManagerStrategy:C,sdkConfigTrackingManagerBatchIntervals:y,sdkConfigTrackingManagerPoolMaxSize:T,httpRequestUrl:k,httpRequestMethod:E,httpRequestHeaders:S,httpRequestBody:R,httpResponseTime:N,httpResponseUrl:A,httpResponseMethod:D,httpResponseHeaders:b,httpResponseCode:M,httpResponseBody:O,visitorStatus:F,visitorInstanceType:H,visitorContext:w,visitorConsent:V,visitorAssignmentHistory:x,visitorFlags:U,visitorIsAuthenticated:P,config:B,flagKey:G,flagValue:Q,flagDefault:q,flagMetadataCampaignId:K,flagMetadataVariationGroupId:$,flagMetadataVariationId:j,flagMetadataCampaignSlug:z,flagMetadataCampaignType:J,sdkConfigFetchNow:W,sdkConfigReuseVisitorIds:Y,sdkConfigInitialBucketing:Z,sdkConfigDecisionApiUrl:X,sdkConfigHitDeduplicationTime:tt,flagshipInstanceId:it,hitContent:et,traffic:st,lastInitializationTimestamp:nt,lastBucketingTimestamp:at,batchTriggeredBy:ot,visitorCampaigns:rt,visitorCampaignFromCache:ht,visitorInitialCampaigns:gt,visitorInitialFlagsData:ct,flagMetadataCampaignIsReference:dt,contextKey:ut,contextValue:lt,sdkBucketingFile:ft,flagMetadataCampaignName:pt,flagMetadataVariationGroupName:vt,flagMetadataVariationName:It,sdkConfigUsingCustomHitCache:mt,sdkConfigUsingCustomVisitorCache:_t,sdkConfigUsingOnVisitorExposed:Ct,sdkConfigFetchThirdPartyData:yt,sdkConfigFetchFlagsBufferingTime:Tt,sdkConfigDisableDeveloperUsageTracking:kt,sdkConfigNextFetchConfig:Et,sdkConfigDisableCache:St,visitorSessionId:Rt,sdkConfigLogLevel:Nt}=t;this.visitorSessionId=Rt,this.sdkConfigDisableCache=St,this.sdkConfigDisableDeveloperUsageTracking=kt,this.sdkConfigNextFetchConfig=Et,this.sdkConfigFetchFlagsBufferingTime=Tt,this.sdkConfigFetchThirdPartyData=yt,this.sdkConfigUsingCustomHitCache=mt,this.sdkConfigUsingCustomVisitorCache=_t,this.sdkConfigUsingOnVisitorExposed=Ct,this.flagMetadataCampaignName=pt,this.flagMetadataVariationGroupName=vt,this.flagMetadataVariationName=It,this.traffic=st,this.sdkBucketingFile=ft,this.contextKey=ut,this.contextValue=lt,this.lastBucketingTimestamp=at,this.lastInitializationTimestamp=nt,this.batchTriggeredBy=ot,this.visitorCampaigns=rt,this.visitorAssignmentHistory=x,this.visitorInitialCampaigns=gt,this.visitorInitialFlagsData=ct,this.visitorCampaignFromCache=ht,this.flagMetadataCampaignIsReference=dt,this.config=B,this.version=i||"1",this.logLevel=e,this.flagshipInstanceId=it,this.accountId=s,this.envId=a||B.envId,this.timestamp=o||new Date(Date.now()).toISOString(),this.timeZone=this.getTimezone(),this.label=r,this.stackType=h||"SDK",this.stackName=g||n.name,this.stackVersion=c||n.version,this.stackOriginName=d,this.stackOriginVersion=u,this.sdkStatus=l,this.sdkConfigMode=f,this.sdkConfigCustomLogManager=p,this.sdkConfigCustomCacheManager=v,this.sdkConfigStatusListener=I,this.sdkConfigTimeout=m,this.sdkConfigPollingInterval=_,this.sdkConfigTrackingManagerStrategy=C,this.sdkConfigTrackingManagerBatchIntervals=y,this.sdkConfigTrackingManagerPoolMaxSize=T,this.sdkConfigFetchNow=W,this.sdkConfigReuseVisitorIds=Y,this.sdkConfigInitialBucketing=Z,this.sdkConfigDecisionApiUrl=X,this.sdkConfigHitDeduplicationTime=tt,this.httpRequestUrl=k,this.httpRequestMethod=E,this.httpRequestHeaders=S,this.httpRequestBody=R,this.httpResponseUrl=A,this.httpResponseMethod=D,this.httpResponseHeaders=b,this.httpResponseCode=M,this.httpResponseBody=O,this.httpResponseTime=N,this.visitorStatus=F,this.visitorInstanceType=H,this.visitorContext=w,this.visitorConsent=V,this.visitorAssignmentHistory=x,this.visitorFlags=U,this.visitorIsAuthenticated=P,this.flagKey=G,this.flagValue=Q,this.flagDefault=q,this.flagMetadataCampaignId=K,this.flagMetadataVariationGroupId=$,this.flagMetadataVariationId=j,this.flagMetadataCampaignSlug=z,this.flagMetadataCampaignType=J,this.hitContent=et,this.ds=L,this.sdkConfigLogLevel=Nt}getTimezone(){return("object"==typeof Intl?Intl.DateTimeFormat()?.resolvedOptions()?.timeZone:void 0)||""+(new Date).getTimezoneOffset()/60}toApiKeys(){const t={[w]:this.visitorId,[V]:this.ds,[F]:`${this.config?.envId}`,t:this.type,cv:{}},i={version:`${this.version}`,logLevel:`${It[this.logLevel]}`,timestamp:`${this.timestamp}`,timeZone:`${this.timeZone}`,label:`${this.label}`,"stack.type":`${this.stackType}`,"stack.name":`${this.stackName}`,"stack.version":`${this.stackVersion}`};if(void 0!==this.lastBucketingTimestamp&&(i.lastBucketingTimestamp=`${this.lastBucketingTimestamp}`),void 0!==this.lastInitializationTimestamp&&(i.lastInitializationTimestamp=`${this.lastInitializationTimestamp}`),void 0!==this.flagshipInstanceId&&(i.flagshipInstanceId=`${this.flagshipInstanceId}`),this.accountId&&(i.accountId=`${this.accountId}`),this.envId&&(i.envId=`${this.envId}`),void 0!==this.sdkBucketingFile&&(i.sdkBucketingFile=JSON.stringify(this.sdkBucketingFile)),void 0!==this.stackOriginName&&(i["stack.origin.name"]=`${this.stackOriginName}`),void 0!==this.stackOriginVersion&&(i["stack.origin.version"]=`${this.stackOriginVersion}`),void 0!==this.sdkStatus&&(i["sdk.status"]=`${pt[this.sdkStatus]}`),void 0!==this.sdkConfigLogLevel&&(i["sdk.config.logLevel"]=`${It[this.sdkConfigLogLevel]}`),void 0!==this.sdkConfigMode&&(i["sdk.config.mode"]=`${this.sdkConfigMode}`),void 0!==this.sdkConfigCustomLogManager&&(i["sdk.config.customLogManager"]=`${this.sdkConfigCustomLogManager}`),void 0!==this.sdkConfigCustomCacheManager&&(i["sdk.config.customCacheManager"]=`${this.sdkConfigCustomCacheManager}`),void 0!==this.sdkConfigStatusListener&&(i["sdk.config.custom.StatusListener"]=`${this.sdkConfigStatusListener}`),void 0!==this.sdkConfigTimeout&&(i["sdk.config.timeout"]=""+1e3*this.sdkConfigTimeout),void 0!==this.sdkConfigPollingInterval&&(i["sdk.config.pollingTime"]=""+1e3*this.sdkConfigPollingInterval),void 0!==this.sdkConfigTrackingManagerStrategy&&(i["sdk.config.trackingManager.strategy"]=`${_t[this.sdkConfigTrackingManagerStrategy]}`),void 0!==this.sdkConfigTrackingManagerBatchIntervals&&(i["sdk.config.trackingManager.batchIntervals"]=""+1e3*this.sdkConfigTrackingManagerBatchIntervals),void 0!==this.sdkConfigTrackingManagerPoolMaxSize&&(i["sdk.config.trackingManager.poolMaxSize"]=`${this.sdkConfigTrackingManagerPoolMaxSize}`),void 0!==this.sdkConfigFetchNow&&(i["sdk.config.fetchNow"]=`${this.sdkConfigFetchNow}`),void 0!==this.sdkConfigReuseVisitorIds&&(i["sdk.config.reuseVisitorIds"]=`${this.sdkConfigReuseVisitorIds}`),void 0!==this.sdkConfigInitialBucketing&&(i["sdk.config.initialBucketing"]=JSON.stringify(this.sdkConfigInitialBucketing)),void 0!==this.sdkConfigDecisionApiUrl&&(i["sdk.config.decisionApiUrl"]=`${this.sdkConfigDecisionApiUrl}`),void 0!==this.sdkConfigHitDeduplicationTime&&(i["sdk.config.hitDeduplicationTime"]=""+1e3*this.sdkConfigHitDeduplicationTime),void 0!==this.sdkConfigUsingCustomHitCache&&(i["sdk.config.usingCustomHitCache"]=JSON.stringify(this.sdkConfigUsingCustomHitCache)),void 0!==this.sdkConfigUsingCustomVisitorCache&&(i["sdk.config.usingCustomVisitorCache"]=JSON.stringify(this.sdkConfigUsingCustomVisitorCache)),void 0!==this.sdkConfigUsingOnVisitorExposed&&(i["sdk.config.usingOnVisitorExposed"]=JSON.stringify(this.sdkConfigUsingOnVisitorExposed)),void 0!==this.sdkConfigFetchThirdPartyData&&(i["sdk.config.fetchThirdPartyData"]=JSON.stringify(this.sdkConfigFetchThirdPartyData)),void 0!==this.sdkConfigFetchFlagsBufferingTime&&(i["sdk.config.fetchFlagsBufferingTime"]=JSON.stringify(1e3*this.sdkConfigFetchFlagsBufferingTime)),void 0!==this.sdkConfigNextFetchConfig&&(i["sdk.config.nextFetchConfig"]=JSON.stringify(this.sdkConfigNextFetchConfig)),void 0!==this.sdkConfigDisableDeveloperUsageTracking&&(i["sdk.config.disableDeveloperUsageTracking"]=JSON.stringify(this.sdkConfigDisableDeveloperUsageTracking)),void 0!==this.sdkConfigDisableCache&&(i["sdk.config.disableCache"]=JSON.stringify(this.sdkConfigDisableCache)),void 0!==this.httpRequestUrl&&(i["http.request.url"]=`${this.httpRequestUrl}`),void 0!==this.httpRequestMethod&&(i["http.request.method"]=`${this.httpRequestMethod}`),void 0!==this.httpRequestHeaders&&(i["http.request.headers"]=JSON.stringify(this.httpRequestHeaders)),void 0!==this.httpRequestBody&&(i["http.request.body"]=JSON.stringify(this.httpRequestBody)),void 0!==this.httpResponseUrl&&(i["http.response.url"]=`${this.httpResponseUrl}`),void 0!==this.httpResponseMethod&&(i["http.response.method"]=`${this.httpResponseMethod}`),void 0!==this.httpResponseHeaders&&(i["http.response.headers"]=JSON.stringify(this.httpResponseHeaders)),void 0!==this.httpResponseCode&&(i["http.response.code"]=`${this.httpResponseCode}`),void 0!==this.httpResponseBody&&(i["http.response.body"]=JSON.stringify(this.httpResponseBody)),void 0!==this.httpResponseTime&&(i["http.response.time"]=`${this.httpResponseTime}`),void 0!==this.visitorId&&(i["visitor.visitorId"]=`${this.visitorId}`),void 0!==this.anonymousId&&(i["visitor.anonymousId"]=`${this.anonymousId}`),void 0!==this.visitorSessionId&&(i["visitor.sessionId"]=`${this.visitorSessionId}`),void 0!==this.visitorStatus&&(i["visitor.status"]=`${this.visitorStatus}`),void 0!==this.visitorInstanceType&&(i["visitor.instanceType"]=`${this.visitorInstanceType}`),void 0!==this.visitorContext)for(const t in this.visitorContext){const e=this.visitorContext[t];i[`visitor.context.[${t}]`]=`${e}`}if(void 0!==this.visitorConsent&&(i["visitor.consent"]=`${this.visitorConsent}`),void 0!==this.visitorAssignmentHistory)for(const t in this.visitorAssignmentHistory){const e=this.visitorAssignmentHistory[t];i[`visitor.assignments.[${t}]`]=e}if(void 0!==this.visitorFlags&&this.visitorFlags.forEach(((t,e)=>{for(const s in t){const n=t[s],a="value"===s||"key"===s,o="string"==typeof n?n:JSON.stringify(n);i[`visitor.flags.[${e}]${a?"":".metadata"}.${s}`]=o}})),void 0!==this.visitorIsAuthenticated&&(i["visitor.isAuthenticated"]=`${this.visitorIsAuthenticated}`),void 0!==this.visitorInitialCampaigns&&(i["visitor.initialCampaigns"]=JSON.stringify(this.visitorInitialCampaigns)),void 0!==this.visitorInitialFlagsData&&(i["visitor.initialFlagsData"]=JSON.stringify(Array.isArray(this.visitorInitialFlagsData)?this.visitorInitialFlagsData:Array.from(this.visitorInitialFlagsData))),void 0!==this.visitorCampaigns&&(i["visitor.campaigns"]=JSON.stringify(this.visitorCampaigns)),void 0!==this.visitorCampaignFromCache&&(i["visitor.campaignFromCache"]=JSON.stringify(this.visitorCampaignFromCache)),void 0!==this.contextKey&&(i.contextKey=`${this.contextKey}`),void 0!==this.contextValue&&(i.contextValue=`${this.contextValue}`),void 0!==this.flagKey&&(i["flag.key"]=`${this.flagKey}`),void 0!==this.flagValue&&(i["flag.value"]=`${this.flagValue}`),void 0!==this.flagDefault&&(i["flag.default"]=JSON.stringify(this.flagDefault)),void 0!==this.flagMetadataCampaignId&&(i["flag.metadata.campaignId"]=`${this.flagMetadataCampaignId}`),void 0!==this.flagMetadataCampaignName&&(i["flag.metadata.campaignName"]=`${this.flagMetadataCampaignName}`),void 0!==this.flagMetadataVariationGroupId&&(i["flag.metadata.variationGroupId"]=`${this.flagMetadataVariationGroupId}`),void 0!==this.flagMetadataVariationGroupName&&(i["flag.metadata.variationGroupName"]=`${this.flagMetadataVariationGroupName}`),void 0!==this.flagMetadataVariationId&&(i["flag.metadata.variationId"]=`${this.flagMetadataVariationId}`),void 0!==this.flagMetadataVariationName&&(i["flag.metadata.variationName"]=`${this.flagMetadataVariationName}`),void 0!==this.flagMetadataCampaignSlug&&(i["flag.metadata.campaignSlug"]=`${this.flagMetadataCampaignSlug}`),void 0!==this.flagMetadataCampaignType&&(i["flag.metadata.campaignType"]=`${this.flagMetadataCampaignType}`),void 0!==this.flagMetadataCampaignIsReference&&(i["flag.metadata.isReference"]=`${this.flagMetadataCampaignIsReference}`),void 0!==this.hitContent)for(const t in this.hitContent){const e=this.hitContent[t];i[`hit.${t}`]="string"==typeof e?e:JSON.stringify(e)}return void 0!==this.batchTriggeredBy&&(i.batchTriggeredBy=`${Tt[this.batchTriggeredBy]}`),t.cv=i,t}isReady(t=!0){return!(t&&!super.isReady())}getErrorMessage(){return"event category and event action are required"}}class Wt extends Jt{constructor(t){super({...t,type:"TROUBLESHOOTING"})}}class Yt{_bucketingContent;_config;_panic=!1;_httpClient;_statusChangedCallback;_troubleshooting;_lastBucketingTimestamp;_trackingManager;_flagshipInstanceId;get trackingManager(){return this._trackingManager}set trackingManager(t){this._trackingManager=t}get flagshipInstanceId(){return this._flagshipInstanceId}set flagshipInstanceId(t){this._flagshipInstanceId=t}get lastBucketingTimestamp(){return this._lastBucketingTimestamp}get troubleshooting(){return this._troubleshooting}set troubleshooting(t){this._troubleshooting=t}get config(){return this._config}set panic(t){this.updateFlagshipStatus(t?pt.SDK_PANIC:pt.SDK_INITIALIZED),this._panic=t,t&&Vt(this.config,"Panic mode is enabled : all feature are disabled except fetchFlags.",z)}statusChangedCallback(t){this._statusChangedCallback=t}constructor(t,i){this._config=i,this._httpClient=t}updateFlagshipStatus(t){"function"==typeof this._statusChangedCallback&&this._statusChangedCallback&&this._statusChangedCallback(t)}getModifications(t){const i=new Map;return t.forEach((t=>{const e=t.variation.modifications.value;for(const s in e){const n=e[s];i.set(s,{key:s,campaignId:t.id,campaignName:t.name||"",variationGroupId:t.variationGroupId,variationGroupName:t.variationGroupName||"",variationId:t.variation.id,variationName:t.variation.name||"",isReference:!!t.variation.reference,campaignType:t.type,slug:t.slug,value:n})}})),i}isPanic(){return this._panic}async getDecisionApiCampaignsAsync(t){const i={[U]:`${this.config.apiKey}`,[B]:n.name,[G]:n.version,[P]:Q},e={visitorId:t.visitorId,anonymousId:t.anonymousId,trigger_hit:!1,context:t.context,visitor_consent:t.hasConsented},s=`${this.config.decisionApiUrl||o}${this.config.envId}/campaigns?exposeAllKeys=true&extras[]=accountSettings`,a=Date.now();try{const t=await this._httpClient.postAsync(s,{headers:i,timeout:this.config.timeout,body:e,nextFetchConfig:this.config.nextFetchConfig});this.panic=!!t?.body?.panic;let n=null;t?.body?.campaigns&&(n=t.body.campaigns);const a=t?.body?.extras?.accountSettings?.troubleshooting;return a&&(this.troubleshooting={startDate:new Date(a.startDate),endDate:new Date(a.endDate),timezone:a.timezone,traffic:a.traffic}),n}catch(n){const o=new Wt({label:Ct.GET_CAMPAIGNS_ROUTE_RESPONSE_ERROR,logLevel:It.ERROR,visitorId:t.visitorId,anonymousId:t.anonymousId,visitorSessionId:t.instanceId,traffic:100,config:this.config,visitorContext:t.context,httpRequestBody:e,httpRequestHeaders:i,httpRequestMethod:"POST",httpRequestUrl:s,httpResponseBody:n?.message,httpResponseHeaders:n?.headers,httpResponseCode:n?.statusCode,httpResponseTime:Date.now()-a});await this.trackingManager.addTroubleshootingHit(o);const r=Pt(n.message||n,{url:s,headers:i,body:e,duration:Date.now()-a});throw new Error(r)}}}class Zt extends Yt{async getCampaignsAsync(t){return this.getDecisionApiCampaignsAsync(t)}}!function(t){t.PAGE_VIEW="PAGEVIEW",t.PAGE="PAGEVIEW",t.SCREEN_VIEW="SCREENVIEW",t.SCREEN="SCREENVIEW",t.TRANSACTION="TRANSACTION",t.ITEM="ITEM",t.EVENT="EVENT"}(kt||(kt={})),function(t){t.ACTION_TRACKING="Action Tracking",t.USER_ENGAGEMENT="User Engagement"}(Et||(Et={}));class Xt extends zt{_category;_action;_label;_value;get category(){return this._category}set category(t){Object.values(Et).includes(t)?this._category=t:bt(this.config,"The category value must be either EventCategory::ACTION_TRACKING or EventCategory::ACTION_TRACKING","category")}get action(){return this._action}set action(t){this.isNotEmptyString(t,"action")&&(this._action=t)}get label(){return this._label}set label(t){this.isNotEmptyString(t,"label")&&(this._label=t)}get value(){return this._value}set value(t){!Number.isInteger(t)||t<0?bt(this.config,"value must be an integer and be >= 0","value"):this._value=t}constructor(t){super({type:kt.EVENT,userIp:t.userIp,screenResolution:t.screenResolution,locale:t.locale,sessionNumber:t.sessionNumber,visitorId:t.visitorId,anonymousId:t.anonymousId,qaMode:t.qaMode});const{category:i,action:e,label:s,value:n}=t;this.category=i,this.action=e,s&&(this.label=s),n&&(this.value=n)}toApiKeys(){const t=super.toApiKeys();return t.ec=this.category,t.ea=this.action,this.label&&(t.el=this.label),this.value&&(t.ev=this.value),t}toObject(){return{...super.toObject(),category:this.category,action:this.action,label:this.label,value:this.value}}isReady(t=!0){return!(t&&!super.isReady()||!this.category||!this.action)}getErrorMessage(){return"event category and event action are required"}}class ti extends zt{_transactionId;_productName;_productSku;_itemPrice;_itemQuantity;_itemCategory;get transactionId(){return this._transactionId}set transactionId(t){this.isNotEmptyString(t,"transactionId")&&(this._transactionId=t)}get productName(){return this._productName}set productName(t){this.isNotEmptyString(t,"productName")&&(this._productName=t)}get productSku(){return this._productSku}set productSku(t){this.isNotEmptyString(t,"productSku")&&(this._productSku=t)}get itemPrice(){return this._itemPrice}set itemPrice(t){this.isNumeric(t,"itemPrice")&&(this._itemPrice=t)}get itemQuantity(){return this._itemQuantity}set itemQuantity(t){this.isInteger(t,"itemQuantity")&&(this._itemQuantity=Math.trunc(t))}get itemCategory(){return this._itemCategory}set itemCategory(t){this.isNotEmptyString(t,"itemCategory")&&(this._itemCategory=t)}constructor(t){super({type:kt.ITEM,userIp:t.userIp,screenResolution:t.screenResolution,locale:t.locale,sessionNumber:t.sessionNumber,visitorId:t.visitorId,anonymousId:t.anonymousId,qaMode:t.qaMode});const{transactionId:i,productName:e,productSku:s,itemCategory:n,itemPrice:a,itemQuantity:o}=t;this.transactionId=i,this.productName=e,this.productSku=s,n&&(this.itemCategory=n),a&&(this.itemPrice=a),o&&(this.itemQuantity=o)}isReady(t=!0){return!(t&&!super.isReady()||!this.transactionId||!this.productName||!this.productSku)}toApiKeys(){const t=super.toApiKeys();return t.tid=this.transactionId,t.in=this.productName,t.ic=this.productSku,this.itemPrice&&(t.ip=this.itemPrice),this.itemQuantity&&(t.iq=this.itemQuantity),this.itemCategory&&(t.iv=this.itemCategory),t}toObject(){return{...super.toObject(),transactionId:this.transactionId,productName:this.productName,productSku:this.productSku,itemPrice:this.itemPrice,itemQuantity:this.itemQuantity,itemCategory:this.itemCategory}}getErrorMessage(){return"Transaction Id, Item name and item code are required"}}class ii extends zt{_documentLocation;get documentLocation(){return this._documentLocation}set documentLocation(t){this.isNotEmptyString(t,"documentLocation")&&(this._documentLocation=t)}constructor(t){super({type:kt.PAGE_VIEW,userIp:t.userIp,screenResolution:t.screenResolution,locale:t.locale,sessionNumber:t.sessionNumber,visitorId:t.visitorId,anonymousId:t.anonymousId,qaMode:t.qaMode}),this.documentLocation=t.documentLocation}isReady(t=!0){return!(t&&!super.isReady()||!this.documentLocation)}toApiKeys(){const t=super.toApiKeys();return t.dl=this.documentLocation,t}toObject(){return{...super.toObject(),documentLocation:this.documentLocation}}getErrorMessage(){return"documentLocation url is required"}}class ei extends zt{_documentLocation;get documentLocation(){return this._documentLocation}set documentLocation(t){this.isNotEmptyString(t,"documentLocation")&&(this._documentLocation=t)}constructor(t){super({type:kt.SCREEN_VIEW,userIp:t.userIp,screenResolution:t.screenResolution,locale:t.locale,sessionNumber:t.sessionNumber,visitorId:t.visitorId,anonymousId:t.anonymousId,qaMode:t.qaMode}),this.documentLocation=t.documentLocation}isReady(t=!0){return!(t&&!super.isReady()||!this.documentLocation)}toApiKeys(){const t=super.toApiKeys();return t.dl=this.documentLocation,t}toObject(){return{...super.toObject(),documentLocation:this.documentLocation}}getErrorMessage(){return"Screen name is required"}}class si extends zt{_transactionId;_affiliation;_taxes;_currency;_couponCode;_itemCount;_shippingMethod;_paymentMethod;_totalRevenue;_shippingCosts;get transactionId(){return this._transactionId}set transactionId(t){this.isNotEmptyString(t,"transactionId")&&(this._transactionId=t)}get affiliation(){return this._affiliation}set affiliation(t){this.isNotEmptyString(t,"affiliation")&&(this._affiliation=t)}get taxes(){return this._taxes}set taxes(t){this.isNumeric(t,"taxes")&&(this._taxes=t)}get currency(){return this._currency}set currency(t){t&&"string"==typeof t&&3===t.length?this._currency=t:bt(this.config,At("{0} must be a string and have exactly 3 letters","currency"),"currency")}get couponCode(){return this._couponCode}set couponCode(t){this.isNotEmptyString(t,"couponCode")&&(this._couponCode=t)}get itemCount(){return this._itemCount}set itemCount(t){this.isInteger(t,"itemCount")&&(this._itemCount=Math.trunc(t))}get shippingMethod(){return this._shippingMethod}set shippingMethod(t){this.isNotEmptyString(t,"shippingMethod")&&(this._shippingMethod=t)}get paymentMethod(){return this._paymentMethod}set paymentMethod(t){this.isNotEmptyString(t,"paymentMethod")&&(this._paymentMethod=t)}get totalRevenue(){return this._totalRevenue}set totalRevenue(t){this.isNumeric(t,"totalRevenue")&&(this._totalRevenue=t)}get shippingCosts(){return this._shippingCosts}set shippingCosts(t){this.isNumeric(t,"shippingCosts")&&(this._shippingCosts=t)}constructor(t){super({type:kt.TRANSACTION,userIp:t.userIp,screenResolution:t.screenResolution,locale:t.locale,sessionNumber:t.sessionNumber,visitorId:t.visitorId,anonymousId:t.anonymousId,qaMode:t.qaMode});const{transactionId:i,affiliation:e,taxes:s,currency:n,couponCode:a,itemCount:o,shippingMethod:r,paymentMethod:h,totalRevenue:g,shippingCosts:c}=t;this.transactionId=i,this.affiliation=e,s&&(this.taxes=s),n&&(this.currency=n),a&&(this.couponCode=a),o&&(this.itemCount=o),r&&(this.shippingMethod=r),h&&(this.paymentMethod=h),g&&(this.totalRevenue=g),c&&(this.shippingCosts=c)}isReady(t=!0){return!(t&&!super.isReady()||!this.transactionId||!this.affiliation)}toApiKeys(){const t=super.toApiKeys();return t.tid=this.transactionId,t.ta=this.affiliation,this.taxes&&(t.tt=this.taxes),this.currency&&(t.tc=this.currency),this.couponCode&&(t.tcc=this.couponCode),this.itemCount&&(t.icn=this.itemCount),this.shippingMethod&&(t.sm=this.shippingMethod),this.paymentMethod&&(t.pm=this.paymentMethod),this.totalRevenue&&(t.tr=this.totalRevenue),this.shippingCosts&&(t.ts=this.shippingCosts),t}toObject(){return{...super.toObject(),transactionId:this.transactionId,affiliation:this.affiliation,taxes:this.taxes,currency:this.currency,couponCode:this.couponCode,itemCount:this.itemCount,shippingMethod:this.shippingMethod,paymentMethod:this.paymentMethod,totalRevenue:this.totalRevenue,shippingCosts:this.shippingCosts}}getErrorMessage(){return"Transaction Id and Transaction affiliation are required"}}class ni extends zt{_context;get context(){return this._context}set context(t){this._context=t}constructor(t){super({type:"SEGMENT",userIp:t.userIp,screenResolution:t.screenResolution,locale:t.locale,sessionNumber:t.sessionNumber,visitorId:t.visitorId,anonymousId:t.anonymousId,qaMode:t.qaMode}),this.context=t.context}isReady(t=!0){return!(t&&!super.isReady()||!this.context)}toApiKeys(){const t=super.toApiKeys();return t.s=this.context,t}toObject(){return{...super.toObject(),context:this.context}}getErrorMessage(){return"data property is required"}}class ai{_hits;_config;get hits(){return this._hits}get config(){return this._config}constructor(t,i){this._config=i,this._hits=t}toApiKeys(){return{[F]:`${this.config?.envId}`,batch:this.hits.map((t=>{const i=t.toApiKeys();return delete i[F],i}))}}}class oi extends zt{_hits;get hits(){return this._hits}set hits(t){this._hits=t}constructor(t){super({...t,visitorId:"",anonymousId:"",type:"BATCH"}),this.hits=t.hits}isReady(){return!!(super.isReady()&&this.hits&&this.hits.length>0&&this.hits.every((t=>t.isReady(!1))))}toApiKeys(){const t={[V]:this.ds,[F]:`${this.config?.envId}`,t:this.type,[x]:Date.now()-this.createdAt};return t.h=this.hits.map((t=>{const i=t.toApiKeys();return delete i[V],delete i[F],i})),t}getErrorMessage(){return"Please check required fields"}}function ri(t){window?.frames?.ABTastyQaAssistant&&xt()&&window.frames.ABTastyQaAssistant.postMessage(t,"*")}function hi(t){xt()&&(window.flagship={...window.flagship,visitorVariations:t},ri({name:Rt.FsUpdateVisitorAllocatedVariation,value:t}))}function gi(t){ri({name:Rt.FsVisitorExposedVariation,value:t})}function ci(t){ri({name:Rt.FsHIT,value:t.map((t=>({...t,timestamp:Date.now()-t.qt})))})}!function(t){t.QaAssistantClose="ABTASTY_QA_ASSISTANT_CLOSE",t.FsApplyForcedVariations="FS_APPLY_FORCED_VARIATIONS",t.FsResetForcedVariations="FS_RESET_FORCED_VARIATIONS",t.FsQaAssistantReady="FS_QA_ASSISTANT_READY",t.MinimizeQaAssistantClose="ABTASTY_QA_MINIMIZE_QA_ASSISTANT_CLOSE",t.FsTriggerRender="FS_TRIGGER_RENDER"}(St||(St={})),function(t){t.FsUpdateVisitorAllocatedVariation="FS_UPDATE_VISITOR_ALLOCATED_VARIATION",t.FsVisitorExposedVariation="FS_VISITOR_EXPOSED_VARIATION",t.FsHIT="FS_HIT"}(Rt||(Rt={})),function(t){t.FsTriggerRendering="FS_TRIGGER_RENDERING"}(Nt||(Nt={}));class di{_config;_hitsPoolQueue;_activatePoolQueue;_httpClient;_troubleshootingQueue;_usageHitQueue;_flagshipInstanceId;_isUsageHitQueueSending;_isTroubleshootingQueueSending;_HitsToFsQa;_sendFsHitToQATimeoutId;_troubleshootingData;get flagshipInstanceId(){return this._flagshipInstanceId}get troubleshootingData(){return this._troubleshootingData}set troubleshootingData(t){this._troubleshootingData=t}get config(){return this._config}constructor(t){const{config:i,hitsPoolQueue:e,httpClient:s,activatePoolQueue:n,troubleshootingQueue:a,flagshipInstanceId:o,analyticHitQueue:r}=t;this._HitsToFsQa=[],this._config=i,this._hitsPoolQueue=e,this._httpClient=s,this._activatePoolQueue=n,this._troubleshootingQueue=a,this._flagshipInstanceId=o,this._usageHitQueue=r,this._isUsageHitQueueSending=!1,this._isTroubleshootingQueueSending=!1}sendHitsToFsQa(t){xt()&&this.config.isQAModeEnabled&&(this._HitsToFsQa.push(...t),this._HitsToFsQa.length>=10&&(ci(this._HitsToFsQa.map((t=>t.toApiKeys()))),this._HitsToFsQa=[]),this._sendFsHitToQATimeoutId&&clearTimeout(this._sendFsHitToQATimeoutId),this._HitsToFsQa.length&&(this._sendFsHitToQATimeoutId=setTimeout((()=>{ci(this._HitsToFsQa.map((t=>t.toApiKeys()))),this._HitsToFsQa=[]}),3e3)))}async addHit(t){const i=`${t.visitorId}:${Ut()}`;t.key=i,await this.addHitInPoolQueue(t),t.type===kt.EVENT&&t.action===v&&t.label===`${n.name}:false`&&await this.notConsent(t.visitorId),wt(this.config,gt,"The HIT has been added into the pool queue : {0}",t.toApiKeys()),this.config.trackingManagerConfig?.poolMaxSize&&this._hitsPoolQueue.size>=this.config.trackingManagerConfig.poolMaxSize&&this.config.decisionMode!==vt.BUCKETING_EDGE&&this.sendBatch()}async activateFlag(t){const i=`${t.visitorId}:${Ut()}`;if(t.key=i,this.config.decisionMode===vt.BUCKETING_EDGE)return await this.activateFlagEdgeMode(t),void Vt(this.config,At("The ACTIVATE has been added to the pool queue : {0}",JSON.stringify(t.toApiKeys())),"ADD ACTIVATE");let e=[];this._activatePoolQueue.size&&(e=Array.from(this._activatePoolQueue.values())),this._activatePoolQueue.clear(),await this.sendActivate({activateHitsPool:e,currentActivate:t,batchTriggeredBy:Tt.ActivateLength})}async activateFlagEdgeMode(t){this._activatePoolQueue.set(t.key,t),await this.cacheHit(new Map([[t.key,t]]))}onVisitorExposed(t){const i=this.config.onVisitorExposed;if("function"!=typeof i)return;const e={key:t.flagKey,value:t.flagValue,defaultValue:t.flagDefaultValue,metadata:t.flagMetadata};i({exposedVisitor:{id:t.visitorId,anonymousId:t.anonymousId,context:t.visitorContext},fromFlag:e})}async sendBatch(t=Tt.BatchLength){if(this._activatePoolQueue.size){const i=Array.from(this._activatePoolQueue.values());this._activatePoolQueue.clear(),await this.sendActivate({activateHitsPool:i,batchTriggeredBy:t})}const i=new oi({hits:[],ds:L});i.config=this.config;const e=[];for(const[t,s]of this._hitsPoolQueue)if(Date.now()-s.createdAt>=C)e.push(t);else{if(JSON.stringify(i).length>a)break;i.hits.push(s),e.push(t)}if(e.forEach((t=>{this._hitsPoolQueue.delete(t)})),!i.hits.length)return;const s={[P]:Q},n=i.toApiKeys(),o=Date.now();try{await this._httpClient.postAsync(r,{headers:s,body:n,timeout:this.config.timeout,nextFetchConfig:this.config.nextFetchConfig}),wt(this.config,gt,dt,lt,{url:r,body:n,headers:s,nextFetchConfig:this.config.nextFetchConfig,duration:Date.now()-o,batchTriggeredBy:Tt[t]}),await this.flushHits(e),this.sendHitsToFsQa(i.hits)}catch(e){i.hits.forEach((t=>{this._hitsPoolQueue.set(t.key,t)})),Dt(this.config,gt,ct,lt,{httpRequestBody:n,httpRequestHeaders:s,httpRequestMethod:"POST",httpRequestUrl:r,httpResponseBody:e?.message,httpResponseHeaders:e?.headers,httpResponseCode:e?.statusCode,duration:Date.now()-o,batchTriggeredBy:Tt[t]});const a=new Wt({label:Ct.SEND_BATCH_HIT_ROUTE_RESPONSE_ERROR,logLevel:It.ERROR,visitorId:`${this._flagshipInstanceId}`,flagshipInstanceId:this._flagshipInstanceId,traffic:0,config:this.config,httpRequestBody:i.hits,httpRequestHeaders:s,httpResponseBody:e?.message,httpResponseHeaders:e?.headers,httpResponseMethod:"POST",httpResponseUrl:r,httpResponseCode:e?.statusCode,httpResponseTime:Date.now()-o,batchTriggeredBy:t});await this.sendTroubleshootingHit(a)}}async notConsent(t){const i=Array.from(this._hitsPoolQueue).filter((([i,e])=>!(e?.type===kt.EVENT&&e?.action===v||e.visitorId!==t&&e.anonymousId!==t))),e=Array.from(this._activatePoolQueue).filter((([i,e])=>e.visitorId===t||e.anonymousId===t)),s=[];i.forEach((([t])=>{this._hitsPoolQueue.delete(t),s.push(t)})),e.forEach((([t])=>{this._activatePoolQueue.delete(t),s.push(t)})),s.length&&await this.flushHits(s)}async cacheHit(t){try{const i=this.config.hitCacheImplementation;if(this.config.disableCache||!i||"function"!=typeof i.cacheHit)return;const e={};t.forEach(((t,i)=>{const s={version:1,data:{visitorId:t.visitorId,anonymousId:t.anonymousId,type:t.type,content:t.toObject(),time:Date.now()}};e[i]=s})),await i.cacheHit(e),wt(this.config,"CACHE HIT","Hit cache has been saved into database : {0}",e)}catch(t){Dt(this.config,ot,ht,"cacheHit",t.message||t)}}async flushHits(t){try{const i=this.config.hitCacheImplementation;if(this.config.disableCache||!i||"function"!=typeof i.flushHits)return;await i.flushHits(t),wt(this.config,ot,"The following hit keys have been flushed from database : {0}",t)}catch(t){Dt(this.config,ot,ht,"flushHits",t.message||t)}}async flushAllHits(){try{const t=this.config.hitCacheImplementation;if(this.config.disableCache||!t||"function"!=typeof t.flushAllHits)return;await t.flushAllHits(),Vt(this.config,"All hits cache has been flushed from database","FLUSH HIT")}catch(t){Dt(this.config,ot,ht,"flushAllHits",t.message||t)}}isTroubleshootingActivated(){if(!this.troubleshootingData)return!1;const t=new Date;return t>=this.troubleshootingData.startDate&&!(t>this.troubleshootingData.endDate)}async addTroubleshootingHit(t){if(!t.key){const i=`${t.visitorId}:${Ut()}`;t.key=i}this._troubleshootingQueue.set(t.key,t),Vt(this.config,At("The TROUBLESHOOTING HIT has been added to the pool queue : {0}",JSON.stringify(t.toApiKeys())),"ADD TROUBLESHOOTING HIT")}async sendTroubleshootingHit(t){if(!this.isTroubleshootingActivated()||void 0===t.traffic||this.troubleshootingData.traffic<t.traffic)return;const i=t.toApiKeys(),e=Date.now();try{await this._httpClient.postAsync(h,{body:i}),Vt(this.config,At("Troubleshooting hit has been sent : {0}",JSON.stringify({...i,duration:Date.now()-e})),"SEND TROUBLESHOOTING"),t.key&&(this._troubleshootingQueue.delete(t.key),await this.flushHits([t.key]))}catch(s){this.isTroubleshootingActivated()&&await this.addTroubleshootingHit(t),bt(this.config,Pt(s.message||s,{url:h,headers:{},body:i,duration:Date.now()-e}),R)}}async sendTroubleshootingQueue(){if(this.isTroubleshootingActivated()&&!this._isTroubleshootingQueueSending&&0!==this._troubleshootingQueue.size){this._isTroubleshootingQueueSending=!0;for(const[t,i]of Array.from(this._troubleshootingQueue))await this.sendTroubleshootingHit(i);this._isTroubleshootingQueueSending=!1}}async addUsageHit(t){if(!t.key){const i=`${t.visitorId}:${Ut()}`;t.key=i}this._usageHitQueue.set(t.key,t),Vt(this.config,At("The USAGE HIT has been added to the pool queue : {0}",JSON.stringify(t.toApiKeys())),"ADD USAGE HIT")}async sendUsageHit(t){const i=t.toApiKeys(),e=Date.now();try{await this._httpClient.postAsync(g,{body:i}),Vt(this.config,At("Usage hit has been sent : {0}",JSON.stringify({...i,duration:Date.now()-e})),"SEND USAGE HIT"),t.key&&(this._usageHitQueue.delete(t.key),await this.flushHits([t.key]))}catch(s){await this.addUsageHit(t),bt(this.config,Pt(s.message||s,{url:g,headers:{},body:i,duration:Date.now()-e}),R)}}async sendUsageHitQueue(){if(!this._isUsageHitQueueSending&&0!==this._usageHitQueue.size){this._isUsageHitQueueSending=!0;for(const[t,i]of Array.from(this._usageHitQueue))await this.sendUsageHit(i);this._isUsageHitQueueSending=!1}}}class ui extends di{async addHitInPoolQueue(t){this._hitsPoolQueue.set(t.key,t),await this.cacheHit(new Map([[t.key,t]]))}async sendActivate({activateHitsPool:t,currentActivate:i,batchTriggeredBy:e}){const s={[U]:this.config.apiKey,[B]:n.name,[G]:n.version,[P]:Q},a=new ai(Array.from(t.filter((t=>Date.now()-t.createdAt<C))),this.config);i&&a.hits.push(i);const r=a.toApiKeys(),h=o+c,g=Date.now();try{await this._httpClient.postAsync(h,{headers:s,body:r,timeout:this.config.timeout,nextFetchConfig:this.config.nextFetchConfig}),wt(this.config,gt,dt,ut,{httpRequestBody:r,httpRequestHeaders:s,httpRequestMethod:"POST",httpRequestUrl:h,duration:Date.now()-g,batchTriggeredBy:Tt[e]});const i=t.map((t=>t.key));a.hits.forEach((t=>{this.onVisitorExposed(t)})),i.length&&await this.flushHits(i),this.sendHitsToFsQa(a.hits)}catch(t){a.hits.forEach((t=>{this._activatePoolQueue.set(t.key,t)})),i&&await this.cacheHit(new Map([[i.key,i]])),Dt(this.config,gt,ct,ut,{httpRequestBody:r,httpRequestHeaders:s,httpRequestMethod:"POST",httpRequestUrl:h,httpResponseBody:t?.message,httpResponseHeaders:t?.headers,httpResponseCode:t?.statusCode,duration:Date.now()-g,batchTriggeredBy:Tt[e]});const n=new Wt({label:Ct.SEND_ACTIVATE_HIT_ROUTE_ERROR,logLevel:It.ERROR,visitorId:`${this._flagshipInstanceId}`,traffic:0,config:this.config,httpRequestBody:r,httpRequestHeaders:s,httpRequestMethod:"POST",httpRequestUrl:h,httpResponseBody:t?.message,httpResponseHeaders:t?.headers,httpResponseCode:t?.statusCode,httpResponseTime:Date.now()-g,batchTriggeredBy:e});await this.sendTroubleshootingHit(n)}}}class li extends di{async addHitInPoolQueue(t){this._hitsPoolQueue.set(t.key,t)}async sendActivate({activateHitsPool:t,currentActivate:i,batchTriggeredBy:e}){const s={[U]:this.config.apiKey,[B]:n.name,[G]:n.version,[P]:Q},a=new ai(Array.from(t.filter((t=>Date.now()-t.createdAt<C))),this.config);i&&a.hits.push(i);const r=a.toApiKeys(),h=o+c,g=Date.now();try{await this._httpClient.postAsync(h,{headers:s,body:r,timeout:this.config.timeout,nextFetchConfig:this.config.nextFetchConfig}),wt(this.config,gt,dt,ut,{httpRequestBody:r,httpRequestHeaders:s,httpRequestMethod:"POST",httpRequestUrl:h,duration:Date.now()-g,batchTriggeredBy:Tt[e]}),a.hits.forEach((t=>{this.onVisitorExposed(t)})),this.sendHitsToFsQa(a.hits)}catch(t){a.hits.forEach((t=>{this._activatePoolQueue.set(t.key,t)})),Dt(this.config,gt,ct,ut,{httpRequestBody:r,httpRequestHeaders:s,httpRequestMethod:"POST",httpRequestUrl:h,httpResponseBody:t?.message,httpResponseHeaders:t?.headers,httpResponseCode:t?.statusCode,duration:Date.now()-g,batchTriggeredBy:Tt[e]});const i=new Wt({label:Ct.SEND_ACTIVATE_HIT_ROUTE_ERROR,logLevel:It.ERROR,visitorId:`${this._flagshipInstanceId}`,traffic:0,config:this.config,httpRequestBody:r,httpRequestHeaders:s,httpRequestMethod:"POST",httpRequestUrl:h,httpResponseBody:t?.message,httpResponseHeaders:t?.headers,httpResponseCode:t?.statusCode,httpResponseTime:Date.now()-g,batchTriggeredBy:e});await this.sendTroubleshootingHit(i)}}async sendBatch(t=Tt.BatchLength){let i=!1;if(this._activatePoolQueue.size){const e=Array.from(this._activatePoolQueue.values());this._activatePoolQueue.clear(),await this.sendActivate({activateHitsPool:e,batchTriggeredBy:t}),i=!0}const e={[P]:Q},s=new oi({hits:[]});s.config=this.config;let n=0;const o=[];for(const[t,i]of this._hitsPoolQueue)if(Date.now()-i.createdAt>=C)o.push(t);else{if(n=JSON.stringify(s).length,n>a)break;s.hits.push(i),o.push(t)}if(o.forEach((t=>{this._hitsPoolQueue.delete(t)})),!s.hits.length)return void(i&&await this.cacheHit(this._activatePoolQueue));const h=s.toApiKeys(),g=Date.now();try{await this._httpClient.postAsync(r,{headers:e,body:h,timeout:this.config.timeout,nextFetchConfig:this.config.nextFetchConfig}),wt(this.config,gt,dt,lt,{httpRequestBody:h,httpRequestHeaders:e,httpRequestMethod:"POST",httpRequestUrl:r,duration:Date.now()-g,batchTriggeredBy:Tt[t]}),this.sendHitsToFsQa(s.hits)}catch(i){s.hits.forEach((t=>{this._hitsPoolQueue.set(t.key,t)})),Dt(this.config,gt,ct,lt,{httpRequestBody:h,httpRequestHeaders:e,httpRequestMethod:"POST",httpRequestUrl:r,httpResponseBody:i?.message,httpResponseHeaders:i?.headers,httpResponseCode:i?.statusCode,duration:Date.now()-g,batchTriggeredBy:Tt[t]});const n=new Wt({label:Ct.SEND_BATCH_HIT_ROUTE_RESPONSE_ERROR,logLevel:It.ERROR,visitorId:`${this._flagshipInstanceId}`,traffic:0,config:this.config,httpRequestBody:h,httpRequestHeaders:e,httpResponseBody:i?.message,httpResponseHeaders:i?.headers,httpResponseMethod:"POST",httpResponseUrl:r,httpResponseCode:i?.statusCode,httpResponseTime:Date.now()-g});this.addTroubleshootingHit(n)}const c=new Map([...this._hitsPoolQueue,...this._activatePoolQueue]);await this.flushAllHits(),await this.cacheHit(c)}}class fi extends di{cacheHitKeys;constructor(t){super(t),this.cacheHitKeys={}}async activateFlag(t){const i=`${t.visitorId}:${Ut()}`;t.key=i,await this.sendActivate({activateHitsPool:[],currentActivate:t,batchTriggeredBy:Tt.ActivateLength})}async addHit(t){const i=`${t.visitorId}:${Ut()}`;t.key=i,t.type===kt.EVENT&&t.action===v&&t.label===`${n.name}:false`&&await this.notConsent(t.visitorId),await this.sendHit(t)}addHitInPoolQueue(t){return Promise.resolve()}async sendHit(t){const i={[P]:Q},e=t.toApiKeys(),s=Date.now();try{await this._httpClient.postAsync(r,{headers:i,body:e,timeout:this.config.timeout,nextFetchConfig:this.config.nextFetchConfig}),wt(this.config,gt,dt,"HIT",{httpRequestBody:e,httpRequestHeaders:i,httpRequestMethod:"POST",httpRequestUrl:r,duration:Date.now()-s,batchTriggeredBy:Tt[Tt.DirectHit]}),this.sendHitsToFsQa([t])}catch(n){t.type===kt.EVENT&&t.action===v||(this.cacheHitKeys[t.key]=t.visitorId),await this.cacheHit((new Map).set(t.key,t)),Dt(this.config,gt,ct,"HIT",{httpRequestBody:e,httpRequestHeaders:i,httpRequestMethod:"POST",httpRequestUrl:r,httpResponseBody:n?.message,httpResponseHeaders:n?.headers,httpResponseCode:n?.statusCode,duration:Date.now()-s,batchTriggeredBy:Tt[Tt.DirectHit]});const a=new Wt({label:Ct.SEND_HIT_ROUTE_ERROR,logLevel:It.ERROR,visitorId:`${this._flagshipInstanceId}`,traffic:0,config:this.config,httpRequestBody:e,httpRequestHeaders:i,httpRequestMethod:"POST",httpRequestUrl:r,httpResponseBody:n?.message,httpResponseHeaders:n?.headers,httpResponseCode:n?.statusCode,httpResponseTime:Date.now()-s,batchTriggeredBy:Tt.DirectHit});await this.sendTroubleshootingHit(a)}}async notConsent(t){const i=Object.entries(this.cacheHitKeys).filter((([i,e])=>e===t)),e=[];for(const[t]of i)e.push(t);const s=Array.from(this._hitsPoolQueue).filter((([i,e])=>!(e?.type===kt.EVENT&&e?.action===v||e.visitorId!==t&&e.anonymousId!==t))),n=Array.from(this._activatePoolQueue).filter((([i,e])=>e.visitorId===t||e.anonymousId===t)),a=[];s.forEach((([t])=>{this._hitsPoolQueue.delete(t),a.push(t)})),n.forEach((([t])=>{this._activatePoolQueue.delete(t),a.push(t)}));const o=[...e,...a];o.length&&(await this.flushHits(o),this.cacheHitKeys={})}async sendActivate({activateHitsPool:t,currentActivate:i,batchTriggeredBy:e}){const s={[U]:this.config.apiKey,[B]:n.name,[G]:n.version,[P]:Q},a=new ai(Array.from(t.filter((t=>Date.now()-t.createdAt<C))),this.config);i&&a.hits.push(i);const r=a.toApiKeys(),h=o+c,g=Date.now();try{await this._httpClient.postAsync(h,{headers:s,body:r,timeout:this.config.timeout,nextFetchConfig:this.config.nextFetchConfig}),wt(this.config,gt,dt,ut,{httpRequestBody:r,httpRequestHeaders:s,httpRequestMethod:"POST",httpRequestUrl:h,duration:Date.now()-g,batchTriggeredBy:Tt[e]});const i=t.map((t=>t.key));a.hits.forEach((t=>{this.onVisitorExposed(t)})),i.length&&await this.flushHits(i),this.sendHitsToFsQa(a.hits)}catch(t){a.hits.forEach((t=>{this.cacheHitKeys[t.key]=t.visitorId})),i&&await this.cacheHit(new Map([[i.key,i]])),Dt(this.config,gt,ct,ut,{httpRequestBody:r,httpRequestHeaders:s,httpRequestMethod:"POST",httpRequestUrl:h,httpResponseBody:t?.message,httpResponseHeaders:t?.headers,httpResponseCode:t?.statusCode,duration:Date.now()-g,batchTriggeredBy:Tt[e]});const n=new Wt({label:Ct.SEND_ACTIVATE_HIT_ROUTE_ERROR,logLevel:It.ERROR,visitorId:`${this._flagshipInstanceId}`,traffic:0,config:this.config,httpRequestBody:r,httpRequestHeaders:s,httpRequestMethod:"POST",httpRequestUrl:h,httpResponseBody:t?.message,httpResponseHeaders:t?.headers,httpResponseMethod:"POST",httpResponseUrl:h,httpResponseCode:t?.statusCode,httpResponseTime:Date.now()-g,batchTriggeredBy:e});await this.sendTroubleshootingHit(n)}}}class pi extends zt{_variationGroupId;_variationId;_flagKey;_flagValue;_flagDefaultValue;_flagMetadata;_visitorContext;constructor(t){super({type:"ACTIVATE",userIp:t.userIp,screenResolution:t.screenResolution,locale:t.locale,sessionNumber:t.sessionNumber,visitorId:t.visitorId,anonymousId:t.anonymousId,qaMode:t.qaMode});const{variationGroupId:i,variationId:e,flagKey:s,flagValue:n,flagDefaultValue:a,flagMetadata:o,visitorContext:r}=t;this.variationGroupId=i,this.variationId=e,this.flagKey=s,this.flagValue=n,this.flagDefaultValue=a,this.flagMetadata=o,this.visitorContext=r}get variationGroupId(){return this._variationGroupId}set variationGroupId(t){this._variationGroupId=t}get variationId(){return this._variationId}set variationId(t){this._variationId=t}get flagKey(){return this._flagKey}set flagKey(t){this._flagKey=t}get flagValue(){return this._flagValue}set flagValue(t){this._flagValue=t}get flagDefaultValue(){return this._flagDefaultValue}set flagDefaultValue(t){this._flagDefaultValue=t}get flagMetadata(){return this._flagMetadata}set flagMetadata(t){this._flagMetadata=t}get visitorContext(){return this._visitorContext}set visitorContext(t){this._visitorContext=t}isReady(t=!0){return!(t&&!super.isReady()||!this.variationGroupId||!this.variationId)}toApiKeys(){const t={[w]:this.anonymousId||this.visitorId,vaid:this.variationId,caid:this.variationGroupId,cid:this.config.envId,aid:null,[x]:Date.now()-this.createdAt};return this.visitorId&&this.anonymousId&&(t[w]=this.visitorId,t.aid=this.anonymousId),this.qaMode&&(t.qa=this.qaMode),t}toObject(){return{...super.toObject(),variationGroupId:this.variationGroupId,variationId:this.variationId}}getErrorMessage(){return"variationGroupId and variationId are required"}}class vi{_httpClient;_config;_hitsPoolQueue;_activatePoolQueue;_troubleshootingQueue;_analyticHitQueue;strategy;_intervalID;_isPooling=!1;_flagshipInstanceId;get flagshipInstanceId(){return this._flagshipInstanceId}get troubleshootingData(){return this.strategy.troubleshootingData}set troubleshootingData(t){this.strategy.troubleshootingData=t}constructor(t,i,e){this._flagshipInstanceId=e,this._hitsPoolQueue=new Map,this._activatePoolQueue=new Map,this._troubleshootingQueue=new Map,this._analyticHitQueue=new Map,this._httpClient=t,this._config=i,this.strategy=this.initStrategy(),this.lookupHits()}initStrategy(){let t;const i={config:this.config,httpClient:this.httpClient,hitsPoolQueue:this._hitsPoolQueue,activatePoolQueue:this._activatePoolQueue,troubleshootingQueue:this._troubleshootingQueue,analyticHitQueue:this._analyticHitQueue,flagshipInstanceId:this.flagshipInstanceId};switch(this.config.trackingManagerConfig?.cacheStrategy){case _t.PERIODIC_CACHING:t=new li(i);break;case _t.CONTINUOUS_CACHING:t=new ui(i);break;default:t=new fi(i)}return t}get httpClient(){return this._httpClient}get config(){return this._config}async sendTroubleshootingHit(t){await this.strategy.sendTroubleshootingHit(t)}startBatchingLoop(){const t=1e3*this.config.trackingManagerConfig?.batchIntervals;Ft(this.config,gt,"The Batch Loop has been started with a time interval of {0} ms",t),this._intervalID=setInterval((()=>{this.batchingLoop()}),t)}stopBatchingLoop(){clearInterval(this._intervalID),this._isPooling=!1,Ht(this.config,"The Batch Loop has been stopped",gt)}async batchingLoop(){this._isPooling||(this._isPooling=!0,await this.strategy.sendBatch(Tt.Timer),await this.strategy.sendTroubleshootingQueue(),await this.strategy.sendUsageHitQueue(),this._isPooling=!1)}checkLookupHitData(t){return!(1!==t?.version||!t?.data?.type||!t?.data?.content)||(bt(this.config,"JSON DATA must fit the type HitCacheDTO","LOOKUP HIT"),!1)}async lookupHits(){try{const t=this.config.hitCacheImplementation;if(this.config.disableCache||!t||"function"!=typeof t.lookupHits)return;const i=await t.lookupHits();if(wt(this.config,ot,"Hits cache has been loaded from database: {0}",i),!i||!Object.keys(i).length)return;const e=t=>Date.now()-t<=C,s=[];Object.entries(i).forEach((([t,i])=>{if(!this.checkLookupHitData(i)||!e(i.data.time))return void s.push(t);let n;switch(i.data.type){case kt.EVENT:n=new Xt(i.data.content);break;case kt.ITEM:n=new ti(i.data.content);break;case kt.PAGE:n=new ii(i.data.content);break;case kt.SCREEN:n=new ei(i.data.content);break;case"SEGMENT":n=new ni(i.data.content);break;case"ACTIVATE":return n=new pi(i.data.content),n.key=t,n.createdAt=i.data.content.createdAt,n.config=this.config,void this._activatePoolQueue.set(t,n);case kt.TRANSACTION:n=new si(i.data.content);break;default:return}n.key=t,n.createdAt=i.data.content.createdAt,n.config=this.config,this._hitsPoolQueue.set(t,n)})),s.length&&await this.strategy.flushHits(s)}catch(t){Dt(this.config,ot,ht,"lookupHits",t.message||t)}}async sendUsageHit(t){await this.strategy.sendUsageHit(t)}async addTroubleshootingHit(t){await this.strategy.addTroubleshootingHit(t)}}class Ii extends vi{async activateFlag(t){await this.strategy.activateFlag(t)}async addHit(t){await this.strategy.addHit(t)}async sendBatch(){await this.strategy.sendBatch(Tt.Flush)}}class mi{consoleError;consoleWarn;consoleDebug;constructor(){this.consoleError=console.error??console.log,this.consoleWarn=console.warn??console.log,this.consoleDebug=console.debug??console.log}emergency(t,i){this.consoleError(this.formatOutput(It.EMERGENCY,t,i))}alert(t,i){this.consoleError(this.formatOutput(It.ALERT,t,i))}critical(t,i){this.consoleError(this.formatOutput(It.CRITICAL,t,i))}error(t,i){this.consoleError(this.formatOutput(It.ERROR,t,i))}warning(t,i){this.consoleWarn(this.formatOutput(It.WARNING,t,i))}notice(t,i){this.log(It.NOTICE,t,i)}info(t,i){console.info(this.formatOutput(It.INFO,t,i))}debug(t,i){this.consoleDebug(this.formatOutput(It.DEBUG,t,i))}log(t,i,e){console.log(this.formatOutput(t,i,e))}formatOutput(t,i,e){const s=new Date(Date.now()),n=t=>1===t.toString().length?`0${t}`:t;return`[${n(s.getFullYear())}-${n(s.getMonth()+1)}-${n(s.getDate())} ${n(s.getHours())}:${n(s.getMinutes())}:${n(s.getSeconds())}.${n(s.getMilliseconds())}] [Flagship SDK] [${It[t]}] [${e}] : ${i}`}}class _i extends Jt{constructor(t){super({...t,type:"USAGE"})}}const Ci="FS_DEFAULT_HIT_CACHE";class yi{cacheHit(t){const i=localStorage.getItem(Ci)||"{}",e={...JSON.parse(i),...t};return localStorage.setItem(Ci,JSON.stringify(e)),Promise.resolve()}lookupHits(){const t=localStorage.getItem(Ci)||"{}",i=JSON.parse(t);return Promise.resolve(i)}flushHits(t){const i=localStorage.getItem(Ci)||"{}",e=JSON.parse(i);return t.forEach((t=>{delete e[t]})),localStorage.setItem(Ci,JSON.stringify(e)),Promise.resolve()}flushAllHits(){return localStorage.removeItem(Ci),Promise.resolve()}}const Ti="FS_VISITOR_CACHE_";class ki{cacheVisitor(t,i){return localStorage.setItem(Ti+t,JSON.stringify(i)),Promise.resolve()}lookupVisitor(t){const i=localStorage.getItem(Ti+t);return Promise.resolve(i?JSON.parse(i):null)}flushVisitor(t){return localStorage.removeItem(Ti+t),Promise.resolve()}}const Ei="Visitor ID mismatch: {0} vs {1}";class Si{visitor;get configManager(){return this.visitor.configManager}get trackingManager(){return this.configManager.trackingManager}get decisionManager(){return this.configManager.decisionManager}get config(){return this.visitor.config}_murmurHash;constructor(t){const{visitor:i,murmurHash:e}=t;this.visitor=i,this._murmurHash=e}updateCampaigns(t){try{this.visitor.campaigns=t,this.visitor.flagsData=this.decisionManager.getModifications(t)}catch(t){bt(this.config,t.message||t,"updateCampaigns")}}hasTrackingManager(t){const i=this.trackingManager;return i||bt(this.config,At("trackerManager must not be null."),t),!!i}setConsent(t){if(this.visitor.hasConsented=t,t||this.flushVisitor(),!this.hasTrackingManager("setConsent"))return;const i=new Xt({visitorId:this.visitor.visitorId,anonymousId:this.visitor.anonymousId,label:`${n.name}:${this.visitor.hasConsented}`,action:v,category:Et.USER_ENGAGEMENT});i.qaMode=this.config.isQAModeEnabled,i.ds=L,i.config=this.config;const e=new Wt({label:Ct.VISITOR_SEND_HIT,logLevel:It.INFO,traffic:this.visitor.traffic||0,visitorId:this.visitor.visitorId,visitorSessionId:this.visitor.instanceId,flagshipInstanceId:this.visitor.sdkInitialData?.instanceId,anonymousId:this.visitor.anonymousId,config:this.config,hitContent:i.toApiKeys()});this.trackingManager.addHit(i),wt(this.config,"SET_CONSENT","Visitor `{0}` consent has been changed : {1}",this.visitor.visitorId,t),this.decisionManager.troubleshooting?this.trackingManager.sendTroubleshootingHit(e):this.visitor.consentHitTroubleshooting=e}checKLookupVisitorDataV1(t){if(!t||!t.data||!t.data.visitorId)return!1;const i=t.data.campaigns;return!i||!!Array.isArray(i)&&(this.visitor.visitorCacheStatus!==yt.VISITOR_ID_CACHE&&this.visitor.visitorCacheStatus!==yt.VISITOR_ID_CACHE_NOT_ANONYMOUS_ID_CACHE||t.data.visitorId===this.visitor.visitorId?this.visitor.visitorCacheStatus===yt.ANONYMOUS_ID_CACHE&&t.data.visitorId!==this.visitor.anonymousId?(Ft(this.config,ot,Ei,t.data.visitorId,this.visitor.anonymousId),!1):i.every((t=>t.campaignId&&t.type&&t.variationGroupId&&t.variationId)):(Ft(this.config,ot,Ei,t.data.visitorId,this.visitor.visitorId),!1))}checKLookupVisitorData(t){return 1===t.version&&this.checKLookupVisitorDataV1(t)}async lookupVisitor(){try{const t=this.config.visitorCacheImplementation;if(this.config.disableCache||!t||!t.lookupVisitor||"function"!=typeof t.lookupVisitor)return;this.visitor.visitorCacheStatus=yt.NONE;let i=await t.lookupVisitor(this.visitor.visitorId);if(i&&(this.visitor.visitorCacheStatus=yt.VISITOR_ID_CACHE),this.visitor.anonymousId){const e=await t.lookupVisitor(this.visitor.anonymousId);e&&!i?(i=e,this.visitor.visitorCacheStatus=yt.ANONYMOUS_ID_CACHE):!e&&i&&(this.visitor.visitorCacheStatus=yt.VISITOR_ID_CACHE_NOT_ANONYMOUS_ID_CACHE)}if(wt(this.config,ot,"Visitor {0}, visitor cache has been loaded from database: {1}",this.visitor.visitorId,i),!i)return;if(!this.checKLookupVisitorData(i))return void Dt(this.config,ot,at,1,this.visitor.visitorId);this.visitor.visitorCache=i}catch(t){Dt(this.config,ot,rt,this.visitor.visitorId,"lookupVisitor",t.message||t)}}async cacheVisitor(){try{const t=this.config.visitorCacheImplementation;if(this.config.disableCache||!t||"function"!=typeof t.cacheVisitor)return;const i={},e={version:1,data:{visitorId:this.visitor.visitorId,anonymousId:this.visitor.anonymousId,consent:this.visitor.hasConsented,context:this.visitor.context,campaigns:this.visitor.campaigns.map((t=>(i[t.variationGroupId]=t.variation.id,{campaignId:t.id,slug:t.slug,variationGroupId:t.variationGroupId,variationId:t.variation.id,isReference:t.variation.reference,type:t.variation.modifications.type,activated:!1,flags:t.variation.modifications.value})))}};e.data.assignmentsHistory={...this.visitor.visitorCache?.data?.assignmentsHistory,...i},await t.cacheVisitor(this.visitor.visitorId,e);const s=this.visitor.visitorCacheStatus;if((!s||s===yt.NONE||s===yt.VISITOR_ID_CACHE_NOT_ANONYMOUS_ID_CACHE)&&this.visitor.anonymousId){const i={...e,data:{...e.data,visitorId:this.visitor.anonymousId,anonymousId:null}};await t.cacheVisitor(this.visitor.anonymousId,i)}wt(this.config,ot,"Visitor {0}, visitor cache has been saved into database : {0}",this.visitor.visitorId,e),this.visitor.visitorCache=e}catch(t){Dt(this.config,ot,rt,this.visitor.visitorId,"cacheVisitor",t.message||t)}}async flushVisitor(){try{const t=this.config.visitorCacheImplementation;if(this.config.disableCache||!t||"function"!=typeof t.flushVisitor)return;await t.flushVisitor(this.visitor.visitorId),wt(this.config,ot,"Visitor {0}, visitor cache has been flushed from database.",this.visitor.visitorId)}catch(t){Dt(this.config,ot,rt,this.visitor.visitorId,"flushVisitor",t.message||t)}}async sendTroubleshootingHit(t){await this.trackingManager.sendTroubleshootingHit(t)}getCurrentDateTime(){return new Date}getSdkConfigDecisionMode(){return this.config.decisionMode===vt.DECISION_API?"DECISION_API":this.config.decisionMode}async sendSdkConfigAnalyticHit(){if(this.config.disableDeveloperUsageTracking)return;const t=this.visitor.visitorId+this.getCurrentDateTime().toDateString();if(this._murmurHash.murmurHash3Int32(t)%1e3>1)return;const i=this.config.hitCacheImplementation,e=this.config.visitorCacheImplementation,s=i&&!(i instanceof yi),n=e&&!(e instanceof ki),a=new _i({label:Ct.SDK_CONFIG,logLevel:It.INFO,visitorId:this.visitor.sdkInitialData?.instanceId,flagshipInstanceId:this.visitor.sdkInitialData?.instanceId,config:this.config,sdkStatus:this.visitor.getSdkStatus(),lastBucketingTimestamp:this.configManager.decisionManager.lastBucketingTimestamp,lastInitializationTimestamp:this.visitor.sdkInitialData?.lastInitializationTimestamp,sdkConfigMode:this.getSdkConfigDecisionMode(),sdkConfigLogLevel:this.config.logLevel,sdkConfigTimeout:this.config.timeout,sdkConfigPollingInterval:this.config.pollingInterval,sdkConfigTrackingManagerStrategy:this.config.trackingManagerConfig?.cacheStrategy,sdkConfigTrackingManagerBatchIntervals:this.config.trackingManagerConfig?.batchIntervals,sdkConfigTrackingManagerPoolMaxSize:this.config.trackingManagerConfig?.poolMaxSize,sdkConfigFetchNow:this.config.fetchNow,sdkConfigReuseVisitorIds:this.config.reuseVisitorIds,sdkConfigInitialBucketing:this.config.initialBucketing,sdkConfigDecisionApiUrl:this.config.decisionApiUrl,sdkConfigHitDeduplicationTime:this.config.hitDeduplicationTime,sdkConfigUsingOnVisitorExposed:!!this.config.onVisitorExposed,sdkConfigUsingCustomHitCache:!!s,sdkConfigUsingCustomVisitorCache:!!n,sdkConfigFetchThirdPartyData:this.config.fetchThirdPartyData,sdkConfigFetchFlagsBufferingTime:this.config.fetchFlagsBufferingTime,sdkConfigDisableDeveloperUsageTracking:this.config.disableDeveloperUsageTracking,sdkConfigNextFetchConfig:this.config.nextFetchConfig,sdkConfigDisableCache:this.config.disableCache});await this.trackingManager.sendUsageHit(a)}sendFetchFlagsTroubleshooting({isFromCache:t,campaigns:i,now:e}){const s={};this.visitor.flagsData.forEach((t=>{s[t.variationGroupId]=t.variationId}));const n=this.visitor.visitorId+this.decisionManager.troubleshooting?.endDate.toUTCString(),a=this._murmurHash.murmurHash3Int32(n)%100;this.visitor.traffic=a;const o=this.config.hitCacheImplementation,r=this.config.visitorCacheImplementation,h=o&&!(o instanceof yi),g=r&&!(r instanceof ki),c=new Wt({label:Ct.VISITOR_FETCH_CAMPAIGNS,logLevel:It.INFO,visitorId:this.visitor.visitorId,anonymousId:this.visitor.anonymousId,visitorSessionId:this.visitor.instanceId,flagshipInstanceId:this.visitor.sdkInitialData?.instanceId,traffic:a,config:this.config,sdkStatus:this.visitor.getSdkStatus(),visitorContext:this.visitor.context,visitorCampaigns:i,visitorCampaignFromCache:t?i:void 0,visitorConsent:this.visitor.hasConsented,visitorIsAuthenticated:!!this.visitor.anonymousId,visitorFlags:this.visitor.flagsData,visitorAssignmentHistory:s,visitorInitialCampaigns:this.visitor.sdkInitialData?.initialCampaigns,visitorInitialFlagsData:this.visitor.sdkInitialData?.initialFlagsData,lastBucketingTimestamp:this.configManager.decisionManager.lastBucketingTimestamp,lastInitializationTimestamp:this.visitor.sdkInitialData?.lastInitializationTimestamp,httpResponseTime:Date.now()-e,sdkConfigLogLevel:this.config.logLevel,sdkConfigMode:this.getSdkConfigDecisionMode(),sdkConfigTimeout:this.config.timeout,sdkConfigPollingInterval:this.config.pollingInterval,sdkConfigTrackingManagerStrategy:this.config.trackingManagerConfig?.cacheStrategy,sdkConfigTrackingManagerBatchIntervals:this.config.trackingManagerConfig?.batchIntervals,sdkConfigTrackingManagerPoolMaxSize:this.config.trackingManagerConfig?.poolMaxSize,sdkConfigFetchNow:this.config.fetchNow,sdkConfigReuseVisitorIds:this.config.reuseVisitorIds,sdkConfigInitialBucketing:this.config.initialBucketing,sdkConfigDecisionApiUrl:this.config.decisionApiUrl,sdkConfigHitDeduplicationTime:this.config.hitDeduplicationTime,sdkConfigUsingOnVisitorExposed:!!this.config.onVisitorExposed,sdkConfigUsingCustomHitCache:!!h,sdkConfigUsingCustomVisitorCache:!!g,sdkConfigFetchThirdPartyData:this.config.fetchThirdPartyData,sdkConfigFetchFlagsBufferingTime:this.config.fetchFlagsBufferingTime,sdkConfigDisableDeveloperUsageTracking:this.config.disableDeveloperUsageTracking,sdkConfigNextFetchConfig:this.config.nextFetchConfig,sdkConfigDisableCache:this.config.disableCache});this.sendTroubleshootingHit(c)}sendConsentHitTroubleshooting(){const t=this.visitor.consentHitTroubleshooting;t&&(t.traffic=this.visitor.traffic,this.trackingManager.sendTroubleshootingHit(t),this.visitor.consentHitTroubleshooting=void 0)}sendSegmentHitTroubleshooting(){const t=this.visitor.segmentHitTroubleshooting;t&&(t.traffic=this.visitor.traffic,this.trackingManager.sendTroubleshootingHit(t),this.visitor.segmentHitTroubleshooting=void 0)}}const Ri="sdk_deviceLanguage",Ni="sdk_deviceType",Ai="sdk_deviceModel",Di="sdk_city",bi="sdk_region",Mi="sdk_country",Oi="sdk_lat",Fi="sdk_long",Hi="sdk_ip",wi="sdk_osName",Vi="sdk_osVersionName",xi="sdk_osVersionCode",Li="sdk_carrierName",Ui="sdk_internetConnection",Pi="sdk_versionName",Bi="sdk_versionCode",Gi="sdk_interfaceName",Qi="fs_client",qi="fs_version",Ki="fs_users",$i={[Ri]:"string",[Ni]:"string",[Ai]:"string",[Di]:"string",[bi]:"string",[Mi]:"string",[Oi]:"number",[Fi]:"number",[Hi]:"string",[wi]:"string",[Vi]:"string",[xi]:"string",[Li]:"string",[Ui]:"string",[Pi]:"string",[Bi]:"string",[Gi]:"string",[Qi]:"string",[qi]:"string",[Ki]:"string"};class ji{campaignId;campaignName;variationGroupId;variationGroupName;variationId;variationName;isReference;campaignType;slug;constructor(t){const{campaignId:i,variationGroupId:e,variationId:s,isReference:n,campaignType:a,slug:o,variationGroupName:r,variationName:h,campaignName:g}=t;this.campaignId=i,this.variationGroupId=e,this.variationId=s,this.isReference=n,this.campaignType=a,this.campaignName=g,this.variationGroupName=r,this.variationName=h,this.slug=o}static Empty(){return new ji({campaignId:"",campaignName:"",campaignType:"",variationId:"",variationName:"",variationGroupId:"",variationGroupName:"",isReference:!1,slug:null})}}var zi;!function(t){t.FETCHED="FETCHED",t.FETCHING="FETCHING",t.FETCH_REQUIRED="FETCH_REQUIRED",t.PANIC="PANIC"}(zi||(zi={}));class Ji extends Si{checkPredefinedContext(t,i){const e=$i[t];if(!e)return null;let s=!1;return"string"===e?s="string"==typeof i:"number"===e&&(s="number"==typeof i),s||Dt(this.config,b,j,this.visitor.visitorId,t,e),s}updateContextKeyValue(t,i){const e=typeof i;if("string"!=typeof t||""===t)return void Dt(this.config,b,K,this.visitor.visitorId,t);if("string"!==e&&"number"!==e&&"boolean"!==e)return void Dt(this.config,b,$,this.visitor.visitorId,t);if(t===Qi||t===qi||t===Ki)return;const s=this.checkPredefinedContext(t,i);("boolean"!=typeof s||s)&&(this.visitor.context[t]=i)}updateContext(t,i){if("string"==typeof t)return this.updateContextKeyValue(t,i),wt(this.config,b,"visitor `{0}`, context have been updated: key {1}, value {2}, Context {3}",this.visitor.visitorId,t,i,this.visitor.context),void(this.visitor.fetchStatus={status:zi.FETCH_REQUIRED,reason:mt.UPDATE_CONTEXT});if(t){for(const i in t){const e=t[i];this.updateContextKeyValue(i,e)}this.visitor.fetchStatus={status:zi.FETCH_REQUIRED,reason:mt.UPDATE_CONTEXT},wt(this.config,b,"visitor `{0}`, context have been updated: key/value {1}, Context {2}",this.visitor.visitorId,t,this.visitor.context)}else bt(this.visitor.config,"Context must not to be null",b)}clearContext(){this.visitor.context={},this.visitor.loadPredefinedContext(),this.visitor.fetchStatus={status:zi.FETCH_REQUIRED,reason:mt.UPDATE_CONTEXT},wt(this.config,"CLEAR_CONTEXT","visitor `{0}`, context has been cleared cleared `{1}`",this.visitor.visitorId,this.visitor.context)}fetchVisitorCampaigns(t){return Array.isArray(t?.visitorCache?.data.campaigns)?t.visitorCache.data.campaigns.map((t=>({id:t.campaignId,variationGroupId:t.variationGroupId,slug:t.slug,variation:{id:t.variationId,reference:!!t.isReference,modifications:{type:t.type,value:t.flags}}}))):null}isDeDuplicated(t,i){if(0===i)return!1;const e=this.visitor.deDuplicationCache[t];return!!(e&&Date.now()-e<=1e3*i)||(this.visitor.deDuplicationCache[t]=Date.now(),this.visitor.clearDeDuplicationCache(i),!1)}async sendActivate(t,i){const e=new pi({variationGroupId:t.variationGroupId,variationId:t.variationId,visitorId:this.visitor.visitorId,anonymousId:this.visitor.anonymousId,flagKey:t.key,flagValue:t.value,flagDefaultValue:i,visitorContext:this.visitor.context,flagMetadata:{campaignName:t.campaignName,campaignId:t.campaignId,campaignType:t.campaignType,variationGroupId:t.variationGroupId,variationGroupName:t.variationGroupName,variationId:t.variationId,variationName:t.variationName,slug:t.slug,isReference:t.isReference}});e.config=this.config,e.qaMode=this.config.isQAModeEnabled;const{createdAt:s,...n}=e.toObject();if(this.isDeDuplicated(JSON.stringify(n),this.config.hitDeduplicationTime)){const i={visitorId:this.visitor.visitorId,anonymousId:this.visitor.anonymousId,flag:t,delay:0};return void Vt(this.config,At("Activate {0} is deduplicated",JSON.stringify(i)),O)}await this.trackingManager.activateFlag(e);const a=new Wt({label:Ct.VISITOR_SEND_ACTIVATE,logLevel:It.INFO,traffic:this.visitor.traffic,visitorId:e.visitorId,flagshipInstanceId:this.visitor.sdkInitialData?.instanceId,visitorSessionId:this.visitor.instanceId,anonymousId:e.anonymousId,config:this.config,hitContent:e.toApiKeys()});this.sendTroubleshootingHit(a)}async sendHit(t){this.hasTrackingManager(O)&&await this.prepareAndSendHit(t)}async sendHits(t){if(this.hasTrackingManager(O))for(const i of t)await this.prepareAndSendHit(i)}getHit(t){let i=null;switch(t.type.toUpperCase()){case kt.EVENT:i=new Xt(t);break;case kt.ITEM:i=new ti(t);break;case kt.PAGE_VIEW:i=new ii(t);break;case kt.SCREEN_VIEW:i=new ei(t);break;case kt.TRANSACTION:i=new si(t)}return i}async prepareAndSendHit(t,i=O){let e;if(!t?.type)return void bt(this.config,"Hit must not be null",i);if(t instanceof zt)e=t;else{const s=this.getHit(t);if(!s)return void bt(this.config,"property type is required and must ",i);e=s}e.visitorId=this.visitor.visitorId,e.ds=L,e.config=this.config,e.anonymousId=this.visitor.anonymousId,e.qaMode=this.config.isQAModeEnabled;const{createdAt:s,...n}=e.toObject();if(!this.isDeDuplicated(JSON.stringify(n),this.config.hitDeduplicationTime))if(e.isReady())try{if(await this.trackingManager.addHit(e),"SEGMENT"===e.type)return;const t=new Wt({label:Ct.VISITOR_SEND_HIT,logLevel:It.INFO,traffic:this.visitor.traffic,visitorId:e.visitorId,flagshipInstanceId:this.visitor.sdkInitialData?.instanceId,visitorSessionId:this.visitor.instanceId,anonymousId:e.anonymousId,config:this.config,hitContent:e.toApiKeys()});this.sendTroubleshootingHit(t)}catch(t){bt(this.config,t.message||t,i)}else bt(this.config,e.getErrorMessage(),i)}authenticate(t){if(!t)return void Dt(this.config,it,et,this.visitor.visitorId);if(this.visitor.anonymousId)return void Mt(this.config,it,"The visitor is already authenticated with visitor ID {0}",this.visitor.visitorId,this.visitor.anonymousId);this.visitor.anonymousId=this.visitor.visitorId,this.visitor.visitorId=t;const i=new Wt({label:Ct.VISITOR_AUTHENTICATE,logLevel:It.INFO,flagshipInstanceId:this.visitor.sdkInitialData?.instanceId,visitorId:this.visitor.visitorId,anonymousId:this.visitor.anonymousId,visitorContext:this.visitor.context,traffic:this.visitor.traffic,config:this.config});this.sendTroubleshootingHit(i),this.visitor.fetchStatus={status:zi.FETCH_REQUIRED,reason:mt.AUTHENTICATE},wt(this.config,it,"The visitor is authenticated with new visitor ID {0} anonymous ID {1}",this.visitor.visitorId,this.visitor.anonymousId)}unauthenticate(){if(!this.visitor.anonymousId)return void Dt(this.config,st,"Visitor {0} is not authenticated yet",this.visitor.visitorId);this.visitor.visitorId=this.visitor.anonymousId,this.visitor.anonymousId=null;const t=new Wt({label:Ct.VISITOR_UNAUTHENTICATE,logLevel:It.INFO,visitorId:this.visitor.visitorId,anonymousId:this.visitor.anonymousId,flagshipInstanceId:this.visitor.sdkInitialData?.instanceId,visitorContext:this.visitor.context,traffic:this.visitor.traffic,config:this.config});this.sendTroubleshootingHit(t),this.visitor.fetchStatus={status:zi.FETCH_REQUIRED,reason:mt.UNAUTHENTICATE},wt(this.config,st,"The visitor is unauthenticated with visitor ID {0}",this.visitor.visitorId)}async fetchFlags(){const t=z,i=Date.now(),e={visitorId:this.visitor.visitorId,anonymousId:this.visitor.anonymousId,context:this.visitor.context,isFromCache:!1,duration:0};let s,n=null;try{const e=Date.now()-this.visitor.lastFetchFlagsTimestamp,s=this.visitor.fetchStatus.status;if(s===zi.FETCHING)return void await this.visitor.getCampaignsPromise;const a=1e3*this.config.fetchFlagsBufferingTime;if(s===zi.FETCHED&&e<a)return void Ft(this.config,t,"Visitor {0}, fetchFlags has been ignored and will continue to be ignored for the next {1}ms, this delay can be changed with `fetchFlagsBufferingTime` option in the SDK config",this.visitor.visitorId,a-e);wt(this.config,t,"visitor `{0}` fetchFlags process is started",this.visitor.visitorId),this.visitor.fetchStatus={status:zi.FETCHING,reason:mt.NONE},this.visitor.getCampaignsPromise=this.decisionManager.getCampaignsAsync(this.visitor),n=await this.visitor.getCampaignsPromise,this.visitor.lastFetchFlagsTimestamp=Date.now(),this.decisionManager.isPanic()&&(this.visitor.fetchStatus={status:zi.PANIC,reason:mt.NONE}),this.configManager.trackingManager.troubleshootingData=this.decisionManager.troubleshooting,wt(this.config,t,"Visitor {0}, anonymousId {1} with context {2} has just fetched campaigns {3} in {4} ms",this.visitor.visitorId,this.visitor.anonymousId,this.visitor.context,n,Date.now()-i)}catch(i){bt(this.config,i.message,t),s=i,this.visitor.fetchStatus={status:zi.FETCH_REQUIRED,reason:mt.FETCH_ERROR}}try{n||(n=this.fetchVisitorCampaigns(this.visitor),e.isFromCache=!0,n&&(this.visitor.fetchStatus={status:zi.FETCH_REQUIRED,reason:mt.READ_FROM_CACHE},wt(this.config,t,"Visitor {0}, anonymousId {1} with context {2} has just fetched campaigns from cache {3} in {4} ms",this.visitor.visitorId,this.visitor.anonymousId,this.visitor.context,n,Date.now()-i))),n=n||[],this.visitor.campaigns=n,this.visitor.flagsData=this.decisionManager.getModifications(this.visitor.campaigns),this.visitor.emit(y,s),this.visitor.fetchStatus.status===zi.FETCHING&&(this.visitor.fetchStatus={status:zi.FETCHED,reason:mt.NONE});const a={};this.visitor.flagsData.forEach((t=>{a[t.campaignId]={variationId:t.variationId,variationGroupId:t.variationGroupId,campaignId:t.campaignId}})),hi(a),wt(this.config,t,"Visitor {0}, anonymousId {1} with context {2} has just fetched flags {3} from Campaigns",this.visitor.visitorId,this.visitor.anonymousId,this.visitor.context,this.visitor.flagsData),this.decisionManager.troubleshooting&&(this.sendFetchFlagsTroubleshooting({campaigns:n,now:i,isFromCache:e.isFromCache}),this.sendConsentHitTroubleshooting(),this.sendSegmentHitTroubleshooting()),this.sendSdkConfigAnalyticHit()}catch(s){this.visitor.emit(y,s),e.duration=Date.now()-i,bt(this.config,Pt(s.message||s,e),t),this.visitor.fetchStatus={status:zi.FETCH_REQUIRED,reason:mt.FETCH_ERROR};const a=new Wt({label:Ct.VISITOR_FETCH_CAMPAIGNS_ERROR,logLevel:It.INFO,visitorId:this.visitor.visitorId,anonymousId:this.visitor.anonymousId,visitorSessionId:this.visitor.instanceId,flagshipInstanceId:this.visitor.sdkInitialData?.instanceId,traffic:this.visitor.traffic,config:this.config,visitorContext:this.visitor.context,sdkStatus:this.visitor.getSdkStatus(),visitorCampaigns:n,visitorCampaignFromCache:e.isFromCache?n:void 0,visitorConsent:this.visitor.hasConsented,visitorIsAuthenticated:!!this.visitor.anonymousId,visitorFlags:this.visitor.flagsData,visitorInitialCampaigns:this.visitor.sdkInitialData?.initialCampaigns,visitorInitialFlagsData:this.visitor.sdkInitialData?.initialFlagsData,lastBucketingTimestamp:this.configManager.decisionManager.lastBucketingTimestamp,lastInitializationTimestamp:this.visitor.sdkInitialData?.lastInitializationTimestamp,httpResponseTime:Date.now()-i,sdkConfigMode:this.getSdkConfigDecisionMode(),sdkConfigTimeout:this.config.timeout,sdkConfigPollingInterval:this.config.pollingInterval,sdkConfigTrackingManagerStrategy:this.config.trackingManagerConfig?.cacheStrategy,sdkConfigTrackingManagerBatchIntervals:this.config.trackingManagerConfig?.batchIntervals,sdkConfigTrackingManagerPoolMaxSize:this.config.trackingManagerConfig?.poolMaxSize,sdkConfigFetchNow:this.config.fetchNow,sdkConfigReuseVisitorIds:this.config.reuseVisitorIds,sdkConfigInitialBucketing:this.config.initialBucketing,sdkConfigDecisionApiUrl:this.config.decisionApiUrl,sdkConfigHitDeduplicationTime:this.config.hitDeduplicationTime});this.trackingManager.addTroubleshootingHit(a)}}async visitorExposed(t){const{key:i,flag:e,defaultValue:s,hasGetValueBeenCalled:n}=t;if(!e)return Mt(this.visitor.config,Y,'For the visitor "{0}", no flags were found with the key "{1}". As a result, user exposure will not be sent.',this.visitor.visitorId,i),void this.sendFlagTroubleshooting(Ct.VISITOR_EXPOSED_FLAG_NOT_FOUND,i,s);n||(Mt(this.visitor.config,Y,'Visitor "{0}", the flag with the key "{1}" has been exposed without calling the `getValue` method first.',this.visitor.visitorId,i),this.sendFlagTroubleshooting(Ct.FLAG_VALUE_NOT_CALLED,i,s,!0)),null==s||null===e.value||Lt(e.value,s)||(Mt(this.visitor.config,Y,'For the visitor "{0}", the flag with key "{1}" has been exposed despite having a different type compared to the default value',this.visitor.visitorId,i),this.sendFlagTroubleshooting(Ct.VISITOR_EXPOSED_TYPE_WARNING,i,s)),await this.sendActivate(e,s)}sendFlagTroubleshooting(t,i,e,s){const n=new Wt({label:t,logLevel:It.WARNING,visitorId:this.visitor.visitorId,anonymousId:this.visitor.anonymousId,visitorSessionId:this.visitor.instanceId,flagshipInstanceId:this.visitor.sdkInitialData?.instanceId,traffic:this.visitor.traffic,config:this.config,visitorContext:this.visitor.context,flagKey:i,flagDefault:e,visitorExposed:s});this.sendTroubleshootingHit(n)}getFlagValue(t){const{key:i,defaultValue:e,flag:s,visitorExposed:n}=t;return s?(n&&this.sendActivate(s,e),null===s.value?e:null==e||Lt(s.value,e)?(wt(this.config,J,"Visitor {0}, Flag for key {1} returns value {2}",this.visitor.visitorId,i,s.value),s.value):(Mt(this.config,J,'For the visitor "{0}", the flag with key "{1}" has a different type compared to the default value. Therefore, the default value "{2}" has been returned.',this.visitor.visitorId,i,e),this.sendFlagTroubleshooting(Ct.GET_FLAG_VALUE_TYPE_WARNING,i,e,n),e)):(Mt(this.config,J,'For the visitor "{0}", no flags were found with the key "{1}". Therefore, the default value "{2}" has been returned.',this.visitor.visitorId,i,e),this.sendFlagTroubleshooting(Ct.GET_FLAG_VALUE_FLAG_NOT_FOUND,i,e,n),e)}SendFlagMetadataTroubleshooting(t){Mt(this.config,Z,X,this.visitor.visitorId,t);const i=new Wt({label:Ct.GET_FLAG_METADATA_TYPE_WARNING,logLevel:It.WARNING,visitorId:this.visitor.visitorId,anonymousId:this.visitor.anonymousId,visitorSessionId:this.visitor.instanceId,flagshipInstanceId:this.visitor.sdkInitialData?.instanceId,traffic:this.visitor.traffic,config:this.config,visitorContext:this.visitor.context,flagKey:t});this.sendTroubleshootingHit(i)}getFlagMetadata(t){const{key:i,flag:e}=t;return e?new ji({campaignId:e.campaignId,campaignName:e.campaignName,variationGroupId:e.variationGroupId,variationGroupName:e.variationGroupName,variationId:e.variationId,variationName:e.variationName,isReference:!!e.isReference,campaignType:e.campaignType,slug:e.slug}):(Mt(this.config,Z,X,this.visitor.visitorId,i),this.SendFlagMetadataTroubleshooting(i),ji.Empty())}}class Wi extends Ji{async lookupHits(){}async lookupVisitor(){}async cacheVisitor(){}async sendHit(t){this.log("sendHit")}async sendHits(t){this.log("sendHits")}async fetchFlags(){this.log("fetchFlags")}getFlagValue(t){return this.log("Flag.value"),t.defaultValue}async visitorExposed(){this.log(Y)}getFlagMetadata(t){const i=ji.Empty();return Dt(this.config,Z,tt,this.visitor.visitorId,t.key,i),i}async sendActivate(t,i){}async sendTroubleshootingHit(t){}async sendSdkConfigAnalyticHit(){}log(t){Dt(this.config,t,S,this.visitor.visitorId,t,pt[pt.SDK_NOT_INITIALIZED])}}class Yi extends Ji{setConsent(t){this.visitor.hasConsented=t}updateContext(){this.log("updateContext")}clearContext(){this.log("clearContext")}async lookupHits(){}async lookupVisitor(){}async cacheVisitor(){}async cacheHit(){}fetchVisitorCampaigns(){return[]}async sendHit(t){this.log("sendHit")}async sendHits(t){this.log("sendHits")}getFlagValue(t){return this.log("Flag.value"),t.defaultValue}async visitorExposed(){this.log(Y)}getFlagMetadata(t){const i=ji.Empty();return Ft(this.config,Z,"Visitor {0}, Flag for key {1} Method Flag.metadata is deactivated while SDK status is PANIC: Empty metadata object is returned {2}\nLearn more: https://docs.developers.flagship.io/docs/glossary#panic-mode",this.visitor.visitorId,t.key,i),i}async sendTroubleshootingHit(t){}async sendSdkConfigAnalyticHit(){}async sendActivate(t,i){}log(t){Ft(this.config,t,S,this.visitor.visitorId,t,pt[pt.SDK_PANIC])}}class Zi extends Ji{async lookupHits(){}async lookupVisitor(){}async cacheVisitor(){}async cacheHit(){}fetchVisitorCampaigns(){return[]}async sendHit(t){this.log("sendHit")}async sendHits(t){this.log("sendHits")}async sendActivate(t,i){}async visitorExposed(){this.log(Y)}async sendTroubleshootingHit(t){}log(t){Ht(this.config,At("Method {0} is deactivated for visitor {1} : visitor did not consent.",t,this.visitor.visitorId),t)}}const Xi="FS_CLIENT_VISITOR",te={saveVisitorProfile(t){try{localStorage.setItem(Xi,JSON.stringify(t))}catch(t){}},loadVisitorProfile(){let t=null;try{t=localStorage.getItem(Xi)}catch(t){}return t?JSON.parse(t):null}};class ie{murmurHash3Int32(t,i=0){let e,s,n,a;const o=3&t.length,r=t.length-o;e=i;const h=3432918353,g=461845907;for(a=0;a<r;)n=255&t.charCodeAt(a)|(255&t.charCodeAt(++a))<<8|(255&t.charCodeAt(++a))<<16|(255&t.charCodeAt(++a))<<24,++a,n=(65535&n)*h+(((n>>>16)*h&65535)<<16)&4294967295,n=n<<15|n>>>17,n=(65535&n)*g+(((n>>>16)*g&65535)<<16)&4294967295,e^=n,e=e<<13|e>>>19,s=5*(65535&e)+((5*(e>>>16)&65535)<<16)&4294967295,e=27492+(65535&s)+((58964+(s>>>16)&65535)<<16);switch(n=0,o){case 3:n^=(255&t.charCodeAt(a+2))<<16;case 2:n^=(255&t.charCodeAt(a+1))<<8;case 1:n^=255&t.charCodeAt(a),n=(65535&n)*h+(((n>>>16)*h&65535)<<16)&4294967295,n=n<<15|n>>>17,n=(65535&n)*g+(((n>>>16)*g&65535)<<16)&4294967295,e^=n}return e^=t.length,e^=e>>>16,e=2246822507*(65535&e)+((2246822507*(e>>>16)&65535)<<16)&4294967295,e^=e>>>13,e=3266489909*(65535&e)+((3266489909*(e>>>16)&65535)<<16)&4294967295,e^=e>>>16,e>>>0}}class ee extends t.EventEmitter{_visitorId;_context;_flags;_configManager;_campaigns;_hasConsented;_anonymousId;deDuplicationCache;_isCleaningDeDuplicationCache;visitorCache;_exposedVariations;_sendExposedVariationTimeoutId;_instanceId;_traffic;_sdkInitialData;_consentHitTroubleshooting;_segmentHitTroubleshooting;_fetchStatus;_onFetchFlagsStatusChanged;_getCampaignsPromise;get getCampaignsPromise(){return this._getCampaignsPromise}set getCampaignsPromise(t){this._getCampaignsPromise=t}get onFetchFlagsStatusChanged(){return this._onFetchFlagsStatusChanged}set onFetchFlagsStatusChanged(t){this._onFetchFlagsStatusChanged=t}get fetchStatus(){return this._fetchStatus}set fetchStatus(t){this._fetchStatus=t,this.onFetchFlagsStatusChanged&&this.onFetchFlagsStatusChanged(t)}get segmentHitTroubleshooting(){return this._segmentHitTroubleshooting}set segmentHitTroubleshooting(t){this._segmentHitTroubleshooting=t}get consentHitTroubleshooting(){return this._consentHitTroubleshooting}set consentHitTroubleshooting(t){this._consentHitTroubleshooting=t}get sdkInitialData(){return this._sdkInitialData}static SdkStatus;getSdkStatus(){return ee.SdkStatus}lastFetchFlagsTimestamp=0;_visitorCacheStatus;get visitorCacheStatus(){return this._visitorCacheStatus}set visitorCacheStatus(t){this._visitorCacheStatus=t}constructor(t){const{visitorId:i,configManager:e,context:s,isAuthenticated:a,hasConsented:o,initialFlagsData:r,initialCampaigns:h,monitoringData:g,onFetchFlagsStatusChanged:c}=t;super(),this._exposedVariations={},this._sdkInitialData=g,this._instanceId=Ut(),this._isCleaningDeDuplicationCache=!1,this.deDuplicationCache={},this._context={},this._configManager=e;const d=this.config.reuseVisitorIds?te.loadVisitorProfile():null;d&&wt(this.config,M,"Visitor profile has been loaded {0}",d),this.visitorId=i||(!a&&d?.anonymousId?d?.anonymousId:d?.visitorId)||this.generateVisitorId(),this.campaigns=[],this._anonymousId=null,a&&(this._anonymousId=d?.anonymousId||Ut()),this.setConsent(o||!1),this.updateContext(s),this.loadPredefinedContext(),wt(this.config,M,"Predefined Context have been loaded {0}",{fs_client:n.name,fs_version:n.version,fs_users:this.visitorId}),this.updateCache(),this.setInitialFlags(r),this.setInitializeCampaigns(h,!!r),this.onFetchFlagsStatusChanged=c,this.fetchStatus={status:zi.FETCH_REQUIRED,reason:mt.VISITOR_CREATED},wt(this.config,M,"Visitor {0} has been created with context {1}, isAuthenticated:{2} and hasConsented {3}",this.visitorId,this.context,!!a,!!this.hasConsented)}get traffic(){return this._traffic}set traffic(t){this._traffic=t}get instanceId(){return this._instanceId}generateVisitorId(){const t=Ut();return wt(this.config,M,"Visitor identifier is empty. A UUID {0} has been generated.",t),t}clearDeDuplicationCache(t){if(this._isCleaningDeDuplicationCache)return;this._isCleaningDeDuplicationCache=!0;const i=Object.entries(this.deDuplicationCache);for(const[e,s]of i)Date.now()-s>1e3*t&&delete this.deDuplicationCache[e];this._isCleaningDeDuplicationCache=!1}setInitialFlags(t){this._flags=new Map,Array.isArray(t)&&t.forEach((t=>{this._flags.set(t.key,{key:t.key,campaignId:t.campaignId,campaignName:t.campaignName,variationGroupId:t.variationGroupId,variationGroupName:t.variationGroupName,variationId:t.variationId,variationName:t.variationName,isReference:t.isReference,value:Gt(t.hex,this.config)?.v,slug:t.slug,campaignType:t.campaignType})}))}setInitializeCampaigns(t,i){t&&Array.isArray(t)&&!i&&this.getStrategy().updateCampaigns(t)}updateCache(){const t={visitorId:this.visitorId,anonymousId:this.anonymousId};te.saveVisitorProfile(t)}loadPredefinedContext(){this.context.fs_client=n.name,this.context.fs_version=n.version,this.context.fs_users=this.visitorId}get visitorId(){return this._visitorId}set visitorId(t){t&&"string"==typeof t?(this._visitorId=t,this.loadPredefinedContext(),this.visitorCache=void 0):bt(this.config,"visitorId must not be null or empty","VISITOR ID")}get hasConsented(){return this._hasConsented}set hasConsented(t){this._hasConsented=t}setConsent(t){this.hasConsented=t,this.getStrategy().setConsent(t)}get context(){return this._context}set context(t){this._context={},this.updateContext(t)}get flagsData(){return this._flags}set flagsData(t){this._flags=t}get configManager(){return this._configManager}get config(){return this.configManager.config}get campaigns(){return this._campaigns}set campaigns(t){this._campaigns=t}get anonymousId(){return this._anonymousId}set anonymousId(t){this._anonymousId=t}getStrategy(){let t;const i={visitor:this,murmurHash:new ie},e=this.getSdkStatus();return t=void 0===e||e===pt.SDK_NOT_INITIALIZED?new Wi(i):e===pt.SDK_PANIC?new Yi(i):this.hasConsented?new Ji(i):new Zi(i),t}sendExposedVariation(t){t&&xt()&&(this._exposedVariations[t.campaignId]={campaignId:t.campaignId,variationGroupId:t.variationGroupId,variationId:t.variationId},window.flagship={...window.flagship,exposedVariations:this._exposedVariations},this.config.isQAModeEnabled&&(Object.keys(this._exposedVariations).length>=10&&(gi(this._exposedVariations),this._exposedVariations={}),this._sendExposedVariationTimeoutId&&clearTimeout(this._sendExposedVariationTimeoutId),0!==Object.keys(this._exposedVariations).length&&(this._sendExposedVariationTimeoutId=setTimeout((()=>{gi(this._exposedVariations),this._exposedVariations={}}),100))))}}var se;function ne({flagDTO:t,config:i}){if(!(i.isQAModeEnabled&&xt()&&t&&window?.flagship?.forcedVariations))return;const e=window.flagship.forcedVariations[t.campaignId];if(!e)return;const{campaignId:s,campaignName:n,variationGroupId:a,variationGroupName:o,campaignType:r,CampaignSlug:h,variation:g}=e,c=g.modifications.value[t.key];return{key:t.key,campaignId:s,campaignName:n,variationGroupId:a,variationGroupName:o,variationId:g.id,variationName:g.name,isReference:!!g.reference,campaignType:r,slug:h,value:c}}!function(t){t.FETCHED="FETCHED",t.FETCH_REQUIRED="FETCH_REQUIRED",t.NOT_FOUND="NOT_FOUND",t.PANIC="PANIC"}(se||(se={}));class ae{_visitor;_key;_defaultValue;hasGetValueBeenCalled=!1;constructor(t){const{key:i,visitor:e}=t;this._key=i,this._visitor=e}exists(){if(!this._visitor)return!1;const t=this._visitor?.flagsData.get(this._key),i=ne({flagDTO:t,config:this._visitor.config})||t;return!!(i?.campaignId&&i?.variationId&&i?.variationGroupId)}get metadata(){if(!this._visitor)return ji.Empty();const t=this._visitor.flagsData.get(this._key),i=ne({flagDTO:t,config:this._visitor.config});return this._visitor.getFlagMetadata({key:this._key,flag:i||t})}async visitorExposed(){if(!this._visitor)return;const t=this._visitor.flagsData.get(this._key),i=ne({flagDTO:t,config:this._visitor.config});return this._visitor.visitorExposed({key:this._key,flag:i||t,defaultValue:this._defaultValue,hasGetValueBeenCalled:this.hasGetValueBeenCalled})}getValue(t,i=!0){if(this._defaultValue=t,this.hasGetValueBeenCalled=!0,!this._visitor)return t;const e=this._visitor.flagsData.get(this._key),s=ne({flagDTO:e,config:this._visitor.config})||e;return this._visitor.sendExposedVariation(s),this._visitor.getFlagValue({key:this._key,defaultValue:t,flag:s,visitorExposed:i})}get status(){return this._visitor?.fetchStatus?.status===zi.PANIC?se.PANIC:this.exists()?this._visitor?.fetchStatus?.status===zi.FETCH_REQUIRED||this._visitor?.fetchStatus?.status===zi.FETCHING?se.FETCH_REQUIRED:se.FETCHED:se.NOT_FOUND}}class oe{_visitor;_keys=new Set;_flags;constructor(t){const{visitor:i,flags:e}=t;this._visitor=i,this._flags=e||new Map,0===this._flags.size?(this._keys=new Set(i?.flagsData.keys()),this._keys.forEach((t=>{this._flags.set(t,new ae({key:t,visitor:i}))}))):this._keys=new Set(this._flags.keys())}get size(){return this._keys.size}get(t){return this._flags.get(t)||(this._visitor?.config&&Mt(this._visitor?.config,W,'For the visitor "{0}", no flags were found with the key "{1}". Therefore, an empty flag has been returned.',this._visitor?.visitorId,t),new ae({key:t}))}has(t){return this._keys.has(t)}keys(){return this._keys}[Symbol.iterator](){let t=0;const i=Array.from(this._keys);return{next:()=>{if(t<i.length){const e=i[t++];return{value:[e,this._flags.get(e)],done:!1}}return{value:null,done:!0}}}}filter(t){const i=new Map;return this._flags.forEach(((e,s)=>{t(e,s,this)&&i.set(s,e)})),new oe({visitor:this._visitor,flags:i})}async exposeAll(){await Promise.all(Array.from(this._flags.values(),(t=>t.visitorExposed())))}getMetadata(){const t=new Map;return this._flags.forEach(((i,e)=>{t.set(e,i.metadata)})),t}toJSON(){const t=[];return this._flags.forEach(((i,e)=>{const s=i.metadata;t.push({key:e,campaignId:s.campaignId,campaignName:s.campaignName,variationGroupId:s.variationGroupId,variationGroupName:s.variationGroupName,variationId:s.variationId,variationName:s.variationName,isReference:s.isReference,campaignType:s.campaignType,slug:s.slug,hex:Bt({v:i.getValue(null,!1)})})})),t}forEach(t){this._flags.forEach(((i,e)=>{t(i,e,this)}))}}class re extends ee{updateContext(t,i){this.getStrategy().updateContext(t,i),this.loadPredefinedContext()}clearContext(){this.getStrategy().clearContext()}getFlag(t){return this.fetchStatus.status!==zi.FETCHED&&this.fetchStatus.status!==zi.FETCHING&&Mt(this.config,W,function(t){let i="";switch(t){case mt.VISITOR_CREATED:i=`Visitor \`{0}\` has been created ${N}`;break;case mt.UPDATE_CONTEXT:i=`Visitor context for visitor \`{0}\` has been updated ${N}`;break;case mt.AUTHENTICATE:i=`Visitor \`{0}\` has been authenticated ${N}`;break;case mt.UNAUTHENTICATE:i=`Visitor \`{0}\` has been unauthenticated ${N}`;break;case mt.FETCH_ERROR:i='There was an error while fetching flags for visitor `{0}`. So the value of the flag `{1}` may be outdated"';break;case mt.READ_FROM_CACHE:i="Flags for visitor `{0}` have been fetched from cache"}return i}(this.fetchStatus.reason),this.visitorId,t),new ae({key:t,visitor:this})}getFlags(){return new oe({visitor:this})}sendHit(t){return this.getStrategy().sendHit(t)}sendHits(t){return this.getStrategy().sendHits(t)}authenticate(t){this.getStrategy().authenticate(t),this.updateCache()}unauthenticate(){this.getStrategy().unauthenticate(),this.updateCache()}async fetchFlags(){await this.getStrategy().lookupVisitor(),await this.getStrategy().fetchFlags(),await this.getStrategy().cacheVisitor()}visitorExposed(t){return this.getStrategy().visitorExposed(t)}getFlagValue(t){return this.getStrategy().getFlagValue(t)}getFlagMetadata(t){return this.getStrategy().getFlagMetadata(t)}}class he extends Yt{_lastModified;_isPooling;_murmurHash;_isFirstPooling;_intervalID;constructor(t,i,e){super(t,i),this._murmurHash=e,this._isFirstPooling=!0,i.initialBucketing&&(this._bucketingContent=i.initialBucketing)}finishLoop(t){const{response:i,headers:e,url:s,now:n}=t;if(200===i.status){wt(this.config,q,"Polling event with code status 200 : {0}",i.body),this._bucketingContent=i.body,this._lastBucketingTimestamp=(new Date).toISOString();const t=new Wt({visitorId:this.flagshipInstanceId,flagshipInstanceId:this.flagshipInstanceId,label:Ct.SDK_BUCKETING_FILE,traffic:0,logLevel:It.INFO,config:this.config,httpRequestHeaders:e,httpRequestMethod:"POST",httpRequestUrl:s,httpResponseBody:i?.body,httpResponseHeaders:i?.headers,httpResponseCode:i?.status,httpResponseTime:Date.now()-n});this.trackingManager.sendTroubleshootingHit(t)}else 304===i.status&&Vt(this.config,"Polling event with code status 304",q);if(i.headers&&i.headers["last-modified"]){const t=i.headers["last-modified"];this._lastModified!==t&&this.config.onBucketingUpdated&&this.config.onBucketingUpdated(new Date(t)),this._lastModified=t}this._isFirstPooling&&(this._isFirstPooling=!1,this.updateFlagshipStatus(pt.SDK_INITIALIZED)),"function"==typeof this.config.onBucketingSuccess&&this.config.onBucketingSuccess({status:i.status,payload:this._bucketingContent}),this._isPooling=!1}async startPolling(){const t=1e3*this.config.pollingInterval;Ht(this.config,"Bucketing polling process has been started",q),await this.polling(),0!==t&&(this._intervalID=setInterval((()=>{this.polling()}),t))}async polling(){if(this._isPooling)return;this._isPooling=!0,this._isFirstPooling&&this.updateFlagshipStatus(pt.SDK_INITIALIZING);const t=At("https://cdn.flagship.io/{0}/bucketing.json",this.config.envId),i={[U]:`${this.config.apiKey}`,[B]:n.name,[G]:n.version,[P]:Q},e=Date.now();try{this._lastModified&&(i["if-modified-since"]=this._lastModified);const s=await this._httpClient.getAsync(t,{headers:i,timeout:this.config.timeout,nextFetchConfig:this.config.nextFetchConfig});this.finishLoop({response:s,headers:i,url:t,now:e})}catch(s){this._isPooling=!1,bt(this.config,Pt("Polling event failed with error",{url:t,headers:i,nextFetchConfig:this.config.nextFetchConfig,method:"GET",duration:Date.now()-e}),q),this._isFirstPooling&&this.updateFlagshipStatus(pt.SDK_NOT_INITIALIZED),"function"==typeof this.config.onBucketingFail&&this.config.onBucketingFail(new Error(s));const n=new Wt({visitorId:this.flagshipInstanceId,flagshipInstanceId:this.flagshipInstanceId,label:Ct.SDK_BUCKETING_FILE_ERROR,traffic:0,logLevel:It.INFO,config:this.config,httpRequestHeaders:i,httpRequestMethod:"GET",httpRequestUrl:t,httpResponseBody:s?.message,httpResponseHeaders:s?.headers,httpResponseCode:s?.statusCode,httpResponseTime:Date.now()-e});this.trackingManager.sendTroubleshootingHit(n)}}stopPolling(){clearInterval(this._intervalID),this._isPooling=!1,Ht(this.config,"Bucketing polling process has been stopped",q)}async sendContext(t){try{if(Object.keys(t.context).length<=3||!t.hasConsented)return;const i=new ni({context:t.context,visitorId:t.visitorId,anonymousId:t.anonymousId});await t.sendHit(i);const e=new Wt({label:Ct.VISITOR_SEND_HIT,logLevel:It.INFO,traffic:t.traffic||0,visitorId:t.visitorId,visitorSessionId:t.instanceId,flagshipInstanceId:t.sdkInitialData?.instanceId,anonymousId:t.anonymousId,config:this.config,hitContent:i.toApiKeys()});t.segmentHitTroubleshooting=e}catch(t){bt(this.config,t.message||t,"sendContext")}}async getThirdPartySegment(t){const i=At("https://api-data-connector.flagship.io/accounts/{0}/segments/{1}",this.config.envId,t),e=Date.now(),s={};try{const t=(await this._httpClient.getAsync(i,{nextFetchConfig:this.config.nextFetchConfig})).body;if(Array.isArray(t))for(const i of t)s[`${i.partner}::${i.segment}`]=i.value}catch(t){bt(this.config,Pt(t.message||t,{url:i,nextFetchConfig:this.config.nextFetchConfig,duration:Date.now()-e}),"GET_THIRD_PARTY_SEGMENT")}return s}async getCampaignsAsync(t){if(!this._bucketingContent)return null;const i=this._bucketingContent?.accountSettings?.troubleshooting;if(this.troubleshooting=void 0,i&&(this.troubleshooting={startDate:new Date(i.startDate),endDate:new Date(i.endDate),timezone:i.timezone,traffic:i.traffic}),this._bucketingContent.panic)return this.panic=!0,[];if(this.panic=!1,!this._bucketingContent.campaigns)return null;if(this.config.fetchThirdPartyData){const i=await this.getThirdPartySegment(t.visitorId);t.updateContext(i)}await this.sendContext(t);const e=[];return this._bucketingContent.campaigns.forEach((i=>{const s=this.getVisitorCampaigns(i.variationGroups,i.id,i.type,t);s&&(s.slug=i.slug??null,s.name=i.name,e.push(s))})),e}getVisitorCampaigns(t,i,e,s){for(const n of t)if(this.isMatchTargeting(n,s)){const t=this.getVariation(n,s);return t?{id:i,variation:t,variationGroupId:n.id,variationGroupName:n.name,type:e}:null}return null}getVariation(t,i){const e=this._murmurHash.murmurHash3Int32(t.id+i.visitorId)%100;let s=0;for(const n of t.variations){const a=i.visitorCache?.data?.assignmentsHistory,o=a?a[t.id]:null;if(o){const e=t.variations.find((t=>t.id===o));if(!e)continue;return wt(this.config,nt,"Visitor {0}, Variation {1} selected from cache.",i.visitorId,e.id),{id:e.id,name:e.name,modifications:e.modifications,reference:e.reference}}if(void 0!==n.allocation&&(s+=n.allocation,e<=s))return wt(this.config,nt,"Visitor {0}, Variation {1} selected with allocation {2}.",i.visitorId,n.id,s),{id:n.id,modifications:n.modifications,reference:n.reference,name:n.name}}return null}isMatchTargeting(t,i){return!!(t&&t.targeting&&t.targeting.targetingGroups)&&t.targeting.targetingGroups.some((t=>this.checkAndTargeting(t.targetings,i)))}isANDListOperator(t){return["NOT_EQUALS","NOT_CONTAINS"].includes(t)}checkAndTargeting(t,i){let e,s=!1;for(const{key:n,value:a,operator:o}of t){if("EXISTS"===o){if(n in i.context){s=!0;continue}s=!1;break}if("NOT_EXISTS"!==o)if("fs_all_users"!==n){if("fs_users"===n)e=i.visitorId;else{if(!(n in i.context)){s=!1;break}e=i.context[n]}if(s=this.testOperator(o,e,a),!s)break}else s=!0;else{if(n in i.context){s=!1;break}s=!0}}return s}testListOperatorLoop(t,i,e,s){let n=s;for(const a of e)if(n=this.testOperator(t,i,a),n!==s)break;return n}testListOperator(t,i,e){return this.isANDListOperator(t)?this.testListOperatorLoop(t,i,e,!0):this.testListOperatorLoop(t,i,e,!1)}testOperator(t,i,e){let s;if(Array.isArray(e))return this.testListOperator(t,i,e);switch(t){case"EQUALS":s=i===e;break;case"NOT_EQUALS":s=i!==e;break;case"CONTAINS":s=i.toString().includes(e.toString());break;case"NOT_CONTAINS":s=!i.toString().includes(e.toString());break;case"GREATER_THAN":s=i>e;break;case"LOWER_THAN":s=i<e;break;case"GREATER_THAN_OR_EQUALS":s=i>=e;break;case"LOWER_THAN_OR_EQUALS":s=i<=e;break;case"STARTS_WITH":s=i.toString().startsWith(e.toString());break;case"ENDS_WITH":s=i.toString().endsWith(e.toString());break;default:s=!1}return s}}class ge extends Error{_statusCode;_headers;get headers(){return this._headers}get statusCode(){return this._statusCode}constructor(t,i,e){super(i),this._statusCode=t,this._headers=e}}const ce=(t,i)=>fetch(t,i),de=AbortController;class ue{async getResponse(t){const i="application/json"===t.headers.get("Content-Type");let e;const s={};if(t.headers.forEach(((t,i)=>{s[i]=t})),i&&t.ok&&204!==t.status&&(e=await t.json()),t.status>=400){const i=await t.text();throw new ge(t.status,i||t.statusText,s)}return{status:t.status,body:e,headers:s}}async getAsync(t,i){const e=new de,s=setTimeout((()=>e.abort()),1e3*(i?.timeout?i.timeout:2));try{const s=await ce(t,{method:"GET",headers:i?.headers,signal:e.signal,keepalive:!0,next:i?.nextFetchConfig});return this.getResponse(s)}finally{clearTimeout(s)}}async postAsync(t,i){const e=new de,s=setTimeout((()=>e.abort()),i.timeout?1e3*i.timeout:2e3);try{const s=await ce(t,{method:"POST",headers:i.headers,body:JSON.stringify(i.body),signal:e.signal,keepalive:!0,next:i?.nextFetchConfig});return this.getResponse(s)}finally{clearTimeout(s)}}}class le extends he{getCampaignsAsync(t){return super.getCampaignsAsync(t)}}class fe extends qt{constructor(t){super({...t,decisionMode:vt.BUCKETING_EDGE})}}const pe=t=>document.querySelector(`script[src*="${t}"]`);function ve(t=!1){"TypeScript"===n.name&&document.location.reload();const i=new CustomEvent(Nt.FsTriggerRendering,{detail:{forcedReFetchFlags:t}});window.dispatchEvent(i)}function Ie(t,i=null){if(window?.frames?.ABTastyQaAssistant)return;let e={};const s=sessionStorage.getItem(m);try{e=JSON.parse(s||"{}")}catch(t){console.error("Error parsing sessionForcedVariations",t)}window.flagship={...window.flagship,envId:t.envId,forcedVariations:e};const n=i=>{!function({event:t,config:i,func:e}){if(i.isQAModeEnabled&&xt())switch(t.data.name){case St.FsQaAssistantReady:window.flagship?.visitorVariations&&hi(window.flagship?.visitorVariations),window.flagship?.exposedVariations&&gi(window.flagship?.exposedVariations);break;case St.MinimizeQaAssistantClose:case St.QaAssistantClose:!function({config:t,func:i}){t.isQAModeEnabled=!1,sessionStorage.removeItem(I),i&&window.removeEventListener("message",i),document.getElementById(_)?.remove(),window.flagship={...window.flagship,forcedVariations:{}},ve()}({config:i,func:e});break;case St.FsApplyForcedVariations:!function({value:t}){const i=sessionStorage.getItem(m);let e={};try{e=JSON.parse(i||"{}")}catch(t){console.error("Error parsing sessionForcedVariations",t)}e={...e,...t},sessionStorage.setItem(m,JSON.stringify(e)),window.flagship={...window.flagship,forcedVariations:e},ve()}({value:t.data.value});break;case St.FsResetForcedVariations:sessionStorage.removeItem(m),window.flagship={...window.flagship,forcedVariations:{}},ve();break;case St.FsTriggerRender:ve(!0)}}({event:i,config:t,func:n})};window.addEventListener("message",n),Ft(t,"QA assistant","Loading QA Assistant"),function(t){if(pe(f)||pe(p))return;const i=document.createElement("script");i.src=t,i.id=_,document.body.append(i)}(i||d),t.isQAModeEnabled=!0,sessionStorage.setItem(I,"true")}class me{static _instance;_configManager;_config;_status;_visitorInstance;instanceId;lastInitializationTimestamp;set configManager(t){this._configManager=t}get configManager(){return this._configManager}constructor(){this.instanceId=Ut(),this._status=pt.SDK_NOT_INITIALIZED}static getInstance(){return this._instance||(this._instance=new this),this._instance}setStatus(t){if(this._status===t)return;this._status=t,ee.SdkStatus=t;const i=this.getConfig()?.onSdkStatusChanged;Ft(this._config,"SDK STATUS","SDK status has changed:  {0}",pt[t]),this.getConfig().decisionMode!==vt.BUCKETING_EDGE&&(t===pt.SDK_INITIALIZED&&this.configManager?.trackingManager?.startBatchingLoop(),t===pt.SDK_NOT_INITIALIZED&&this.configManager?.trackingManager?.stopBatchingLoop()),i&&i(t)}static getStatus(){return this.getInstance()._status}getStatus(){return this._status}static getConfig(){return this.getInstance()._config}getConfig(){return this._config}getVisitor(){return this._visitorInstance}static getVisitor(){return this.getInstance().getVisitor()}buildConfig(t){let i;switch(t?.decisionMode){case vt.BUCKETING:i=new Kt(t);break;case vt.BUCKETING_EDGE:i=new fe(t);break;default:i=new $t(t)}return i}buildDecisionManager(t,i,e){let s;const n=i=>{t.setStatus(i)};switch(i.decisionMode){case vt.BUCKETING:s=new he(e,i,new ie),s.statusChangedCallback(n),s.startPolling();break;case vt.BUCKETING_EDGE:s=new le(e,i,new ie),s.statusChangedCallback(n);break;default:s=new Zt(e,i),s.statusChangedCallback(n)}return s}static start(t,i,e){const s=this.getInstance(),a=s.buildConfig(e);if(a.envId=t,a.apiKey=i,s._config=a,a.onLog||a.logManager||(a.logManager=new mi),!t||!i)return s.setStatus(pt.SDK_NOT_INITIALIZED),bt(a,k,D),s;wt(a,D,"Flagship SDK version {0} is starting in {1} mode with config {2}",n.version,a.decisionMode,a),!a.hitCacheImplementation&&xt()&&(a.hitCacheImplementation=new yi),!a.visitorCacheImplementation&&xt()&&(a.visitorCacheImplementation=new ki);const o=new ue,r=s.configManager?.decisionManager;r instanceof he&&a.decisionMode!==vt.BUCKETING_EDGE&&r.stopPolling();let h=s.configManager?.trackingManager;return h||(h=new Ii(o,a,s.instanceId)),s.configManager=new jt(a,r,h),s.configManager.decisionManager=s.buildDecisionManager(s,a,o),s.configManager.decisionManager.trackingManager=h,s.configManager.decisionManager.flagshipInstanceId=s.instanceId,s._status!==pt.SDK_INITIALIZING&&s.setStatus(pt.SDK_INITIALIZED),Ht(a,At("Flagship SDK (version: {0}) {1}",n.version,pt[s._status]),D),function(t){if(!xt())return;const i={fs_qa_assistant:d,abtasty_qa_assistant:d,fs_qa_assistant_staging:u,abtasty_qa_assistant_staging:u,fs_qa_assistant_local:l,abtasty_qa_assistant_local:l},e=new URLSearchParams(window.location.search),s=Object.keys(i).find((t=>"true"===e.get(t)))||"";t.isQAModeEnabled||s?Ie(t,i[s]):function(t){Ft(t,"QA assistant","Listening for keyboard events to launch QA Assistant");const i={};document.addEventListener("keydown",(e=>{i[e.key]=!0,sessionStorage.removeItem(m),(i.Control||i.Alt)&&i.q&&i.a&&Ie(t)})),document.addEventListener("keyup",(t=>{delete i[t.key]}))}(t)}(a),s.lastInitializationTimestamp=(new Date).toISOString(),s}async close(){await me.close()}static async close(){await(this._instance?.configManager?.trackingManager?.sendBatch())}newVisitor(t){return me.newVisitor(t)}static newVisitor({visitorId:t,context:i,isAuthenticated:e,hasConsented:s,initialCampaigns:n,initialFlagsData:a,shouldSaveInstance:o,onFetchFlagsStatusChanged:r}){const h=o??xt();if(!this._instance?.configManager){const t=this.getInstance(),i=new $t;i.logManager=new mi,t._config=i;const e=new ue,s=new Ii(e,i),n=new Zt(e,i);t.configManager=new jt(i,n,s),bt(this.getConfig(),A,M)}void 0===s&&Ot(this.getConfig(),"Consent has not been specified. By default, consent is set to false, which may result in some features being deactivated.",M);const g=new re({visitorId:t,context:i||{},isAuthenticated:e??!1,hasConsented:s??!1,configManager:this.getInstance().configManager,initialCampaigns:n,initialFlagsData:a,onFetchFlagsStatusChanged:r,monitoringData:{instanceId:this.getInstance().instanceId,lastInitializationTimestamp:this.getInstance().lastInitializationTimestamp,initialCampaigns:n,initialFlagsData:a}}),c=new ft(g);return this.getInstance()._visitorInstance=h?c:void 0,h&&wt(this.getConfig(),M,"Visitor {0} has been saved in SDK instance",c.visitorId),this.getConfig().fetchNow&&this.getConfig().decisionMode!==vt.BUCKETING_EDGE&&c.fetchFlags(),c}}const _e=me})(),s})()));
//# sourceMappingURL=index.browser.lite.js.map